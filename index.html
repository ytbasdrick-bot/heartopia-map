<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Maptopia FR - Rex System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: url('Heartopia.jpg') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100vw; opacity: 0; transition: opacity 2s ease; background: url('Heartopia.jpg') no-repeat center center !important; background-size: cover !important; }
        
        /* √âCRAN D'ACCUEIL */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('Heartopia.jpg') no-repeat center center; background-size: cover; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease; padding: 20px; }
        #intro-screen::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); }
        
        /* FEN√äTRE DE D√âTAILS (NOUVEAU) */
        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 19000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); animation: fadeIn 0.5s; }
        .welcome-content { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 20px; border: 3px solid #d4af37; text-align: center; position: relative; box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); }
        .welcome-header { font-size: 24px; font-weight: 900; color: #8b0000; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid #d4af37; padding-bottom: 10px; }
        .welcome-text { text-align: left; font-size: 14px; line-height: 1.6; color: #333; margin-bottom: 20px; }
        .welcome-note { background: #fff3cd; border-left: 5px solid #d4af37; padding: 10px; margin: 10px 0; font-size: 13px; color: #856404; font-weight: bold; }
        
        .language-selector { display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 10px; }
        .intro-langs { position: absolute; top: 30px; right: 30px; z-index: 20005; }
        .lang-flag { width: 30px; height: 20px; cursor: pointer; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; transition: 0.3s; object-fit: cover; }
        .lang-flag:hover { transform: scale(1.1); border-color: #d4af37; }
        .lang-flag.active { border-color: #d4af37; box-shadow: 0 0 8px #d4af37; }

        .heartopia-title { position: relative; font-size: 48px; text-align: center; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 4px; background: linear-gradient(to bottom, #fff 20%, #d4af37 50%, #8b6b15 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.8)); font-family: 'Arial Black', sans-serif; z-index: 20001; }
        
        .welcome-box { position: relative; width: 100%; max-width: 500px; padding: 30px; background: rgba(0, 0, 0, 0.85); border: 2px solid #d4af37; border-radius: 25px; color: white; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.7); }
        .details-list { text-align: left; background: rgba(255,255,255,0.08); padding: 15px; border-radius: 12px; margin: 20px 0; font-size: 13px; border-left: 4px solid #d4af37; line-height: 1.5; }
        
        .btn-container { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; }
        .btn-rex { width: 100%; max-width: 320px; padding: 15px 20px; background: linear-gradient(135deg, #8b0000, #d4af37); color: white; border: 2px solid white; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-rex:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(212, 175, 55, 0.5); }

        /* MENU GAUCHE (145px) */
        .leaflet-control-layers { left: 20px !important; top: 20px !important; width: 145px !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 15px !important; padding: 8px !important; max-height: 85vh; overflow-y: auto !important; border: none !important; box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important; }
        .accordion-title { color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; text-align: center; font-size: 11px; text-transform: uppercase; }
        .title-pnj { background: #8b0000; } .title-bus { background: #2980b9; } .title-shop { background: #9b59b6; } .title-lieux { background: #27ae60; } .title-poisson { background: #f39c12; } .title-insecte { background: #2ecc71; } .title-animal { background: #6d4c41; }
        
        .accordion-content { display: none; margin-bottom: 10px; background: #fff; }
        .accordion-content.active { display: block; }
        .menu-item { padding: 8px 5px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; color: #333; transition: background 0.2s; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .menu-item:hover { background: #f9f9f9; }

        /* L√âGENDE DROITE */
        .ping-legend { position: fixed; right: 20px; top: 20px; width: 220px; background: rgba(0,0,0,0.9); border: 2px solid #d4af37; border-radius: 15px; padding: 15px; color: white; z-index: 1000; max-height: 65vh; display: flex; flex-direction: column; }
        .legend-langs { border-bottom: 1px solid #d4af37; padding-bottom: 10px; margin-bottom: 10px; }
        #legend-list { overflow-y: auto; margin-top: 10px; flex-grow: 1; }
        .legend-item { display: flex; flex-direction: column; background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 8px; border-radius: 6px; font-size: 12px; }
        .coord-box { background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; font-family: monospace; font-size: 10px; color: #d4af37; border: 1px solid #555; user-select: all; text-align: center; margin-top: 5px; }
        .visit-counter { margin-top: 15px; padding-top: 10px; border-top: 1px solid #d4af37; text-align: center; }
        .visit-counter p { font-size: 9px; color: #d4af37; margin-bottom: 8px; letter-spacing: 1px; font-weight: bold; }

        /* Styles Carte */
        .label-ville { background: white !important; border: 2px solid #3498db !important; border-radius: 5px; padding: 2px 8px; font-weight: bold; font-size: 11px; color: #2980b9; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .label-eau { background: rgba(41, 128, 185, 0.8) !important; border: 1px solid #fff !important; border-radius: 5px; padding: 2px 8px; font-size: 10px; color: white; font-weight: bold; white-space: nowrap; }
        .invisible-marker { background: transparent !important; border: none !important; }
        .smooth-move { transition: transform 5s linear !important; }

        /* Footer & Overlay */
        .footer-wiki { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; z-index: 3000; background: linear-gradient(90deg, #8b0000, #d4af37, #8b0000); display: flex; align-items: center; justify-content: center; border-top: 3px solid white; }
        .footer-wiki a { color: white; text-decoration: none; font-weight: 900; font-size: 20px; }
        #discord-link { position: fixed; bottom: 85px; right: 20px; z-index: 4000; }
        #discord-img { width: 60px; }
        #overlay-info { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: none; align-items: center; justify-content: center; }
        .info-card { background: white; padding: 25px; border-radius: 20px; border: 3px solid #d4af37; width: 450px; text-align: center; }
        .info-card img { width: 100%; display: block; margin: 0 auto; }
        .info-img-main { mix-blend-mode: multiply; margin-bottom: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<audio id="main-audio"><source src="sonheartopia.mp4" type="audio/mp4"></audio>

<div id="intro-screen">
    <div class="language-selector intro-langs">
        <img src="https://flagcdn.com/w80/fr.png" class="lang-flag active" title="Fran√ßais">
        <a href="https://ytbasdrick-bot.github.io/heartopia-en/"><img src="https://flagcdn.com/w80/gb.png" class="lang-flag" title="Switch to English"></a>
    </div>

    <h1 class="heartopia-title">MAPTOPIA FR</h1>
    <div class="welcome-box">
        <p>Explorez la carte interactive officielle de la communaut√© Heartopia.</p>
        <div class="details-list">
            ‚Ä¢ <b>Navigation :</b> Menu compact √† gauche pour filtrer les cat√©gories.<br>
            ‚Ä¢ <b>Marqueurs :</b> <b>Clic Droit</b> pour placer vos points.<br>
            ‚Ä¢ <b>Infos :</b> Cliquez sur les poissons/insectes pour les d√©tails.<br>
            ‚Ä¢ <b>Sauvegarde :</b> Vos donn√©es sont conserv√©es localement.
        </div>
        
        <div class="btn-container">
            <button id="enter-button" class="btn-rex" onclick="startExperience()">ENTRER SUR LA CARTE</button>
            <a href="https://jayibwi.wixsite.com/my-site-1" target="_blank" style="text-decoration: none; width:100%; display:flex; justify-content:center;">
                <button class="btn-rex">VISITER LE WIKI BY JUNE</button>
            </a>
        </div>
    </div>
</div>

<div id="welcome-modal">
    <div class="welcome-content">
        <div class="welcome-header">CHERS HEARTOPIEN(NE)S</div>
        <div class="welcome-text">
            Bienvenue sur <b>Maptopia</b>, votre compagnon de route pour explorer Heartopia !<br><br>
            
            <div class="welcome-note">
                üêæ <b>IMPORTANT - ANIMAUX :</b><br>
                Les positions des animaux sur cette carte sont <b>dynamiques</b> ! Ils se d√©placent al√©atoirement dans leur zone d'habitat r√©elle. Cherchez aux alentours du marqueur indiqu√©.
            </div>

            üõ†Ô∏è <b>√âTAT DU PROJET :</b><br>
            Ce site est actuellement en d√©veloppement. Des mises √† jour r√©guli√®res apporteront de nouvelles fonctionnalit√©s et corrections.<br><br>
            
            üîç <b>CAT√âGORIES :</b><br>
            Utilisez le menu (√† gauche) pour afficher ou masquer les cat√©gories. Pour garder la carte lisible, les ic√¥nes s'effacent automatiquement lorsque vous changez de section.
        </div>
        <button class="btn-rex" onclick="closeWelcome()">J'AI COMPRIS, C'EST PARTI !</button>
    </div>
</div>

<a href="https://discord.gg/dc8eZwf2jq" target="_blank" id="discord-link"><img src="Discord-Logo-PNG-Pic.png" id="discord-img"></a>

<div class="ping-legend">
    <div class="language-selector legend-langs">
        <img src="https://flagcdn.com/w80/fr.png" class="lang-flag active" style="width:25px; height:16px;">
        <a href="https://ytbasdrick-bot.github.io/heartopia-en/"><img src="https://flagcdn.com/w80/gb.png" class="lang-flag" style="width:25px; height:16px;"></a>
    </div>
    
    <div style="text-align:center; font-weight:bold; border-bottom:1px solid #d4af37; padding-bottom:5px; font-size:12px;">üìå MES MARQUEURS</div>
    <div id="legend-list"></div>
    
    <div class="visit-counter">
        <p>VISITEURS TOTAUX</p>
        <div id="compteur-container">
            <a href="https://www.freecounterstat.com" title="page counter">
                <img src="https://counter11.optistats.ovh/private/freecounterstat.php?c=8e8vjwy4nxu9z2z9v7f9d8m6u1n8z9z9" border="0" title="page counter" alt="page counter">
            </a>
        </div>
    </div>
</div>

<div id="map"></div>

<div id="overlay-info" onclick="this.style.display='none'">
    <div class="info-card" onclick="event.stopPropagation()">
        <h2 id="info-name" style="color:#333; margin-top:0;"></h2>
        <img id="info-main" class="info-img-main">
        <img id="info-cond">
        <button onclick="document.getElementById('overlay-info').style.display='none'" style="margin-top:15px; padding:10px 20px; cursor:pointer; background:#8b0000; color:white; border:none; border-radius:5px; font-weight:bold;">FERMER</button>
    </div>
</div>

<div class="footer-wiki"><a href="https://jayibwi.wixsite.com/my-site-1" target="_blank">üìñ ACC√âDER AU WIKI BY JUNE üìñ</a></div>

<script>
    const colors = { rouge: '#e74c3c', bleu: '#3498db', vert: '#2ecc71', jaune: '#f1c40f', violet: '#9b59b6', orange: '#e67e22' };
    const icons = { note: 'üìå', fish: 'üé£', bird: 'ü¶ú', bug: 'ü¶ã', wood: 'üå≤', stone: '‚õ∞Ô∏è' };

    // ETAPE 1 : ENTREE
    function startExperience() {
        document.getElementById('main-audio').play().catch(() => {});
        document.getElementById('intro-screen').style.opacity = '0';
        document.getElementById('map').style.opacity = '1';
        setTimeout(() => { 
            document.getElementById('intro-screen').style.display = 'none';
            // Affiche la fen√™tre de d√©tails
            document.getElementById('welcome-modal').style.display = 'flex';
        }, 800);
    }

    // ETAPE 2 : FERMETURE MODAL
    function closeWelcome() {
        document.getElementById('welcome-modal').style.display = 'none';
    }

    var bounds = [[-1000, 0], [0, 1000]];
    var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1, zoomControl: false, maxBounds: bounds, maxBoundsViscosity: 1.0 });

    L.imageOverlay('carte.png', bounds).addTo(map);
    map.setView([-500, 500], 1);

    var userPings = JSON.parse(localStorage.getItem('maptopia_pings')) || [];
    var pingMarkers = {};
    var tempPingMarker = null;

    function createFinalMarker(p) {
        var markerHtml = `<div style="background:${colors[p.color]};width:28px;height:28px;border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;">${icons[p.icon]}</div>`;
        var marker = L.marker(p.latlng, {icon: L.divIcon({className:'', html:markerHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);
        marker.bindPopup(`<div style="text-align:center;"><b>${p.text}</b><br><div class="coord-box">${p.latlng.lat.toFixed(1)}, ${p.latlng.lng.toFixed(1)}</div><button onclick="removeUserPing('${p.id}')" style="width:100%; background:#e74c3c; color:white; border:none; padding:5px; margin-top:5px; cursor:pointer; border-radius:3px;">Supprimer</button></div>`);
        pingMarkers[p.id] = marker;
    }

    map.on('contextmenu', (e) => {
        if(tempPingMarker) map.removeLayer(tempPingMarker);
        var mid = "temp_" + Date.now();
        var tempHtml = `<div style="background:gray;width:28px;height:28px;border:2px dashed white;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0.7;">?</div>`;
        tempPingMarker = L.marker(e.latlng, {icon: L.divIcon({className:'', html:tempHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);
        tempPingMarker.tempColor = 'bleu';
        var div = document.createElement('div');
        div.style.minWidth = "180px";
        div.innerHTML = `<b style="display:block;margin-bottom:5px;text-align:center;">Nouveau Marqueur</b><input type="text" id="in-${mid}" placeholder="Nom..." style="width:100%; padding:5px; margin-bottom:10px; box-sizing:border-box;"><div style="display:flex; gap:5px; margin-bottom:10px; justify-content:center;">${Object.entries(colors).map(([k,v]) => `<div style="background:${v}; width:20px; height:20px; border-radius:50%; cursor:pointer; border:1px solid transparent;" onclick="selectPingColor('${k}', this)"></div>`).join('')}</div><button onclick="confirmPing('${mid}',${e.latlng.lat},${e.latlng.lng})" style="width:100%; background:#27ae60; color:white; border:none; padding:8px; cursor:pointer; border-radius:4px; font-weight:bold;">CONFIRMER</button><button onclick="cancelPing()" style="width:100%; background:#95a5a6; color:white; border:none; padding:5px; cursor:pointer; border-radius:4px; margin-top:5px; font-size:10px;">ANNULER</button>`;
        tempPingMarker.bindPopup(div, {closeOnClick: false}).openPopup();
    });

    window.selectPingColor = (c, el) => { tempPingMarker.tempColor = c; el.parentElement.querySelectorAll('div').forEach(d => d.style.borderColor='transparent'); el.style.borderColor='black'; };
    window.cancelPing = () => { if(tempPingMarker) { map.removeLayer(tempPingMarker); tempPingMarker = null; } };
    window.confirmPing = (mid, lat, lng) => {
        var v = document.getElementById('in-'+mid).value || "Lieu";
        var id = "id_"+Date.now();
        var newPing = {id:id, latlng:{lat,lng}, text:v, color:tempPingMarker.tempColor, icon:'note'};
        userPings.push(newPing);
        localStorage.setItem('maptopia_pings', JSON.stringify(userPings));
        map.removeLayer(tempPingMarker);
        tempPingMarker = null;
        createFinalMarker(newPing);
        updateUserLegend();
    };

    window.removeUserPing = (id) => { if(pingMarkers[id]) map.removeLayer(pingMarkers[id]); userPings = userPings.filter(p => p.id != id); localStorage.setItem('maptopia_pings', JSON.stringify(userPings)); updateUserLegend(); };
    
    function updateUserLegend() {
        const list = document.getElementById('legend-list'); list.innerHTML = "";
        userPings.forEach(p => {
            const div = document.createElement('div'); div.className='legend-item';
            div.innerHTML = `<div style="width:100%; display:flex; justify-content:space-between; align-items:center;"><span onclick="map.flyTo([${p.latlng.lat},${p.latlng.lng}], 2)" style="cursor:pointer;">${icons[p.icon]} ${p.text}</span><button onclick="removeUserPing('${p.id}')" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">X</button></div><div class="coord-box">${p.latlng.lat.toFixed(1)}, ${p.latlng.lng.toFixed(1)}</div>`;
            list.appendChild(div);
        });
    }

    var dataStorage = { pnj:[], bus:[], shop:[], lieux:[], animal:[] };
    var currentSingleMarker = null;

    function triggerMovement(item) {
        if (!map.hasLayer(item.marker)) return;
        if(item.marker._icon) item.marker._icon.classList.add('smooth-move');
        let newLat = item.pos[0] + (Math.random() - 0.5) * (item.radius / 1.5);
        let newLng = item.pos[1] + (Math.random() - 0.5) * (item.radius / 1.5);
        item.marker.setLatLng([newLat, newLng]);
        item.moveTimer = setTimeout(() => triggerMovement(item), 7000);
    }

    function register(cat, pos, name, img, opts = {}) {
        let m;
        if(opts.type) { 
            m = L.marker(pos, { icon: L.divIcon({ className: 'invisible-marker', html: '', iconSize: [1, 1] }) }).bindTooltip(name, { permanent: true, direction: 'center', className: opts.type }); 
            if(opts.startOn) m.addTo(map); 
        }
        else { 
            m = L.marker(pos, { icon: L.icon({ iconUrl: img, iconSize: (cat=='bus'?[85,85]:[60,60]), iconAnchor: (cat=='bus'?[42,85]:[30,60]) }) });
            if(cat !== 'pnj' && cat !== 'bus' && cat !== 'shop') { m.bindPopup(`<b>${name}</b>`); }
            if(opts.startOn) m.addTo(map); 
        }
        dataStorage[cat].push({name, pos, marker:m, category:cat, radius: opts.radius || 50, moveTimer: null});
    }

    // --- DONN√âES ---
    [[-471,501,"Bob","pnj/bob.png"],[-526,499,"Atara","pnj/atara.png"],[-478,493,"Collectionneur","pnj/collectioneur.png"],[-469,488,"Doroth√©e","pnj/doroth√©e.png"],[-446,493,"Massimo","pnj/massimo.png"],[-412,418,"Ka Ching","pnj/ka ching.png"],[-399,591,"Andrew","pnj/andrew.png"],[-259,522,"Eric","pnj/eric.png"],[-456,549,"Vanya","pnj/vanya.png"],[-502,582,"Naniwa","pnj/niniwa.png"],[-502,519,"Joan","pnj/joa.png"],[-807,419,"Will","pnj/will.png"],[-355,809,"Patti","pnj/patti.png"],[-653,225,"Vernie","pnj/vernie.png"],[-498,526,"Bayley","pnj/bayley.png"],[-528.3,560.3,"Blanc","pnj/blanc.png"],[-499.8,499.0,"Annie","pnj/annie.png"]].forEach(d => register('pnj', [d[0],d[1]], d[2], d[3]));
    [ ["Banlieue Ouest",[-533,340]], ["Banlieue du village",[-519,639]], ["Village de p√™cheurs",[-654,479]], ["Champ de fleurs",[-532,218]], ["Source thermale",[-222,512]], ["Banlieue Nord",[-373,480]], ["Place centrale",[-497,481]], ["For√™t",[-500,798]]].forEach(b => register('bus', b[1], b[0], 'bus.png', {startOn: true}));
    [[-472,487,"V√™tements","vetement.png"],[-474,503,"Meubles","Meuble.png"],[-496,523,"Animaux","chien.png"],[-440,467,"Librairie","Librairie.png"]].forEach(s => register('shop', [s[0],s[1]], s[2], s[3]));
    register('animal', [-691, 783], "Panda", "panda.png", {radius: 60});
    register('animal', [-184, 291], "Capybara", "capybara.png", {radius: 50});
    register('animal', [-533, 340], "Lapin", "lapin.png", {radius: 40});
    register('animal', [-649, 185], "Renard", "renard.png", {radius: 70});
    register('animal', [-692, 506], "Loutre", "loutre.png", {radius: 40});
    register('animal', [-737, 512], "Vison", "vison.png", {radius: 10});
    register('animal', [-531, 805], "Cerf", "cerf.png", {radius: 60});
    register('animal', [-725, 208], "Lama", "lama.png", {radius: 50});
    [{pos:[-538,492], name:"Place centrale", type:"label-ville", startOn:true}, {pos:[-692,506], name:"Village de p√™cheurs", type:"label-ville", startOn:true}, {pos:[-438,513], name:"Rue des r√©sidents", type:"label-ville", startOn:true}, {pos:[-649,185], name:"Champs de fleurs", type:"label-ville", startOn:true}, {pos:[-440,184], name:"Montagne de la baleine", type:"label-ville", startOn:true}, {pos:[-184,291], name:"Les Ruines", type:"label-ville", startOn:true}, {pos:[-223,501], name:"Montagne de la source thermale", type:"label-ville", startOn:true}, {pos:[-228,627], name:"Falaise rocheuse", type:"label-ville", startOn:true}, {pos:[-531,805], name:"For√™t de ch√™nes spirituels", type:"label-ville", startOn:true}, {pos:[-494,429], name:"Rue des arts", type:"label-ville", startOn:true}, {pos:[-510,558], name:"Rue des jardins", type:"label-ville", startOn:true}, {pos:[-736,602], name:"Quai oriental", type:"label-ville", startOn:true}, {pos:[-690,402], name:"Le Quai", type:"label-ville", startOn:true}, {pos:[-780,387], name:"Phare", type:"label-ville", startOn:true}, {pos:[-691,783], name:"Plongeoir", type:"label-ville", startOn:true}, {pos:[-338,933], name:"√éle de la for√™t", type:"label-ville", startOn:true}, {pos:[-587,406], name:"Banlieue", type:"label-ville", startOn:true}, {pos:[-725,208], name:"Plage violette", type:"label-ville", startOn:true}, {pos:[-783,478], name:"Mer calme", type:"label-eau", startOn:true}, {pos:[-534,92], name:"Mer de la baleine", type:"label-eau", startOn:true}, {pos:[-68,497], name:"Ancienne mer", type:"label-eau", startOn:true}, {pos:[-536,232], name:"Lac de la prairie", type:"label-eau", startOn:true}, {pos:[-337,319], name:"Rivi√®re Aurore", type:"label-eau", startOn:true}, {pos:[-176,394], name:"Lac volcanique", type:"label-eau", startOn:true}, {pos:[-265,537], name:"Lac thermique", type:"label-eau", startOn:true}, {pos:[-344,652], name:"Rivi√®re peu profonde", type:"label-eau", startOn:true}, {pos:[-598,748], name:"Lac de la for√™t", type:"label-eau", startOn:true}, {pos:[-431,774], name:"Haut lac de la for√™t", type:"label-eau", startOn:true}, {pos:[-608,481], name:"Lac de banlieue", type:"label-eau", startOn:true}, {pos:[-669,368], name:"Rivi√®re calme", type:"label-eau", startOn:true}, {pos:[-674,627], name:"Fleuve d'arbres g√©ants", type:"label-eau", startOn:true}].forEach(l => register('lieux', l.pos, l.name, '', {type:l.type, startOn:l.startOn}));
    
    const fishList = [{name:"Ablette", bg:"condition/AA1.png", cond:"condition/Lacs.png"}, {name:"Carpe argent√©e", bg:"condition/AA1.png", cond:"condition/Lacs.png"}, {name:"Grenouille europ√©enne", bg:"condition/AA1.png", cond:"condition/Lacs.png"}, {name:"Langouste europ√©enne", bg:"condition/LL1.png", cond:"condition/Lacs.png"}, {name:"Acantharchus pomotis", bg:"condition/AA2.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Barbillon", bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Ecrevisse noble", bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Ecrevisse noble bleue", bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Grand black-basse", bg:"condition/GG1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Grande hu√Ætre perli√®re", bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Tanche dor√©e", bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"}, {name:"Eperlan", bg:"condition/AA1.png", cond:"condition/Lac_dans_la_prairie.png"}, {name:"Poisson rouge", bg:"condition/AA1.png", cond:"condition/Lac_dans_la_prairie.png"}, {name:"Plie europ√©enne", bg:"condition/LL1.png", cond:"condition/Ancienne_mer.png"}, {name:"Poisson-clown", bg:"condition/AA1.png", cond:"condition/Ancienne_mer.png"}, {name:"Poisson √©pineux", bg:"condition/AA1.png", cond:"condition/Ancienne_mer.png"}, {name:"Poisson-globe de rivi√®re", bg:"condition/LL4.png", cond:"condition/Ancienne_mer.png"}, {name:"Aphyosemion striatum", bg:"condition/AA4.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Barbeau", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Carpe noire", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Loche des rochers", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Moule", bg:"condition/CC3.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Omble chevalier", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Ombrine", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Poisson √† yeux rouges", bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"}, {name:"Loche des fleurs", bg:"condition/AA1.png", cond:"condition/Fleuve_darbres_geants.png"}, {name:"POISSON-TIGRE √† ventre rouge", bg:"condition/AA1.png", cond:"condition/Fleuve_darbres_geants.png"}, {name:"Sandre blanc", bg:"condition/GG1.png", cond:"condition/Fleuve_darbres_geants.png"}, {name:"Perche de prunier", bg:"condition/LL4.png", cond:"condition/Lacs_montagne_thermale.png"}, {name:"Hippocampe", bg:"condition/HH1.png", cond:"condition/Mer_baleine.png"}, {name:"Maquereau atlantique", bg:"condition/AA1.png", cond:"condition/Mer_baleine.png"}, {name:"Saumon atlantique", bg:"condition/MM1.png", cond:"condition/Mer_baleine.png"}, {name:"Saurel", bg:"condition/AA1.png", cond:"condition/Mer_baleine.png"}, {name:"Pagellus bogaraveo", bg:"condition/AA1.png", cond:"condition/Mer_calme.png"}, {name:"Pieuvre naine atlantique", bg:"condition/AA1.png", cond:"condition/Mer_calme.png"}, {name:"Poisson ruban", bg:"condition/AA1.png", cond:"condition/Mer_calme.png"}, {name:"Bernard l'Hermite", bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"}, {name:"Crevette de la mer", bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"}, {name:"Eglefin", bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"}, {name:"Gobie", bg:"condition/GG4.png", cond:"condition/Mer_de_lEst.png"}, {name:"Grondin perlon", bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"}, {name:"Bonite", bg:"condition/AA1.png", cond:"condition/Ocean.png"}, {name:"Chim√®re argent√©e", bg:"condition/AA1.png", cond:"condition/Ocean.png"}, {name:"Perche de mer", bg:"condition/AA1.png", cond:"condition/Ocean.png"}, {name:"Sardine", bg:"condition/AA1.png", cond:"condition/Ocean.png"}, {name:"Baudroie", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"Carpe Papillon", bg:"condition/CC3.png", cond:"condition/Peche_en_mer.png"}, {name:"Pieuvre", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"R√©galec", bg:"condition/GG4.png", cond:"condition/Peche_en_mer.png"}, {name:"Rouget barbet", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"Roussette", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"Seiche europ√©enne", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"Turbot", bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"}, {name:"Blennie de rivi√®re", bg:"condition/AA1.png", cond:"condition/Riviere_Aurore.png"}, {name:"Carpe europ√©enne", bg:"condition/CC2.png", cond:"condition/Riviere_Aurore.png"}, {name:"Zingel streber", bg:"condition/AA1.png", cond:"condition/Riviere_Aurore.png"}, {name:"Com√®te coussut", bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"}, {name:"Lotte", bg:"condition/LL4.png", cond:"condition/Riviere_calme.png"}, {name:"Saumon k√©ta", bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"}, {name:"Vairon", bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"}, {name:"Epinoche", bg:"condition/AA1.png", cond:"condition/Riviere_peu_profonde.png"}, {name:"Crevette verte", bg:"condition/AA1.png", cond:"condition/Rivieres.png"}, {name:"Perche de rivi√®re", bg:"condition/AA1.png", cond:"condition/Rivieres.png"}, {name:"Tilapia", bg:"condition/AA1.png", cond:"condition/Rivieres.png"}, {name:"Chabot", bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"}, {name:"F√©ra", bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"}, {name:"T√™tard", bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"}];
    const bugList = [{name:"Actias neidhoederi", cond:"insecte/Banlieue.png", bg:"insecte/Actias%20neidhoederi2.png"}, {name:"Azur√© de porcelaine", cond:"insecte/Centre%20ville.png", bg:"insecte/Azur√©%20de%20porcelaine2.png"}, {name:"Bourdon", cond:"insecte/Champs%20de%20fleurs%20+%20Montagne%20de%20baleine.png", bg:"insecte/Bourdon2.png"}, {name:"C√©toine √©toil√©e bleue", cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/C√©toine%20√©toil√©e%20bleue2.png"}, {name:"Cicind√®le verte", cond:"insecte/Montagne%20thermale.png", bg:"insecte/Cicind√®le%20verte2.png"}, {name:"Citron aspasia", cond:"insecte/Banlieue.png", bg:"insecte/Citron%20aspasia2.png"}, {name:"Coccinelle √† sept points", cond:"insecte/Banlieue.png", bg:"insecte/Coccinelle%20√†%20sept%20points2.png"}, {name:"Coccinelle asiatique", cond:"insecte/Tour%20du%20faon.png", bg:""}, {name:"Crioc√®re de l'asperge", cond:"insecte/Champs%20de%20fleurs%20+%20Montagne%20de%20baleine.png", bg:"insecte/Crioc√®re%20de%20l'asperge2.png"}, {name:"Criquet aux pattes massives", cond:"insecte/Village%20p√™cheurs.png", bg:"insecte/Criquet%20aux%20pattes%20massives2.png"}, {name:"Grand agrion", cond:"insecte/Bords%20d'eau%20fr√©quent%20pour%20l'agroin.png", bg:"insecte/Grand%20agrion2.png"}, {name:"Libellule tachet√©e", cond:"insecte/Lacs%20de%20banlieue.png", bg:"insecte/Libellule%20tachet√©e2.png"}, {name:"Papillon √† anneaux rouges", cond:"insecte/Event%20insect.png", bg:"insecte/Papillon%20√†%20anneaux%20rouges2.png"}, {name:"Papillon √† col rouge", cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/C√©toine%20√©toil√©e%20bleue2.png"}, {name:"Papillon blanc", cond:"insecte/Village%20p√™cheurs.png", bg:"insecte/Papillon%20blanc2.png"}, {name:"Papillon dor√©", cond:"insecte/For√™t.png", bg:"insecte/Papillon%20dor√©2.png"}, {name:"Parnassien", cond:"insecte/Event%20insect.png", bg:"insecte/Parnassien2.png"}, {name:"Pi√©ride du cresson", cond:"insecte/Centre%20ville.png", bg:"insecte/Pi√©ride%20du%20cresson2.png"}, {name:"Punaise Picasso", cond:"insecte/Plage%20violette.png", bg:"insecte/Criquet%20aux%20pattes%20massives2.png"}, {name:"Pyrochroa", cond:"insecte/Source%20thermale.png", bg:"insecte/Pyrochroa2.png"}, {name:"Pyrrhocoris apterus", cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/Pyrrhocoris%20apterus2.png"}, {name:"Sauterelle de l'oasis", cond:"insecte/Montagne%20thermale.png", bg:"insecte/Sauterelle%20de%20l'oasis2.png"}, {name:"Scarab√©e unicorne", cond:"insecte/Quai%20oriental.png", bg:"insecte/Azur√©%20de%20porcelaine2.png"}];

    var menuCtrl = L.control({position: 'topleft'});
    menuCtrl.onAdd = function() {
        var div = L.DomUtil.create('div', 'leaflet-control-layers'); div.id = "main-menu";
        div.innerHTML = `<div id="c-pnj"><div class="accordion-title title-pnj">PNJs</div><div class="accordion-content"></div></div>
                         <div id="c-animal"><div class="accordion-title title-animal">ANIMAUX</div><div class="accordion-content"></div></div>
                         <div id="c-bus"><div class="accordion-title title-bus">ARR√äTS DE BUS</div><div class="accordion-content"></div></div>
                         <div id="c-shop"><div class="accordion-title title-shop">MAGASINS</div><div class="accordion-content"></div></div>
                         <div id="c-lieux"><div class="accordion-title title-lieux">LIEUX</div><div class="accordion-content"></div></div>
                         <div id="c-fish"><div class="accordion-title title-poisson">POISSONS</div><div class="accordion-content"></div></div>
                         <div id="c-bug"><div class="accordion-title title-insecte">INSECTES</div><div class="accordion-content"></div></div>`;
        return div;
    };
    menuCtrl.addTo(map);

    function initMenu() {
        ['pnj','animal','bus','shop','lieux'].forEach(cat => {
            var box = document.getElementById('c-'+cat), content = box.querySelector('.accordion-content');
            
            box.querySelector('.accordion-title').onclick = () => {
                const isOpening = !content.classList.contains('active');
                document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
                if(isOpening) {
                    content.classList.add('active');
                    if(currentSingleMarker) {
                         if(currentSingleMarker.moveTimer) clearTimeout(currentSingleMarker.moveTimer);
                         map.removeLayer(currentSingleMarker.marker);
                         currentSingleMarker = null;
                    }
                }
            };

            dataStorage[cat].forEach(item => {
                var el = document.createElement('div'); el.className = 'menu-item'; el.innerHTML = item.name;
                el.onclick = () => { 
                    if(cat !== 'bus' && cat !== 'lieux') { 
                        if(currentSingleMarker) {
                             if(currentSingleMarker.moveTimer) clearTimeout(currentSingleMarker.moveTimer);
                             map.removeLayer(currentSingleMarker.marker);
                        }
                        currentSingleMarker = item;
                        item.marker.setLatLng(item.pos).addTo(map);
                        if(item.marker._icon) item.marker._icon.classList.remove('smooth-move');
                        if(cat === 'animal') setTimeout(() => triggerMovement(item), 500);
                    }
                    map.flyTo(item.pos, 2, { animate: false }); 
                };
                content.appendChild(el);
            });
        });

        // POISSONS ET INSECTES
        ['fish', 'bug'].forEach(type => {
            let box = document.getElementById('c-'+type), content = box.querySelector('.accordion-content');
            let list = (type === 'fish' ? fishList : bugList);
            
            box.querySelector('.accordion-title').onclick = () => {
                const isOpening = !content.classList.contains('active');
                document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
                if(isOpening) {
                    content.classList.add('active');
                    if(currentSingleMarker) {
                         if(currentSingleMarker.moveTimer) clearTimeout(currentSingleMarker.moveTimer);
                         map.removeLayer(currentSingleMarker.marker);
                         currentSingleMarker = null;
                    }
                }
            };

            list.forEach(item => {
                let el = document.createElement('div'); el.className = 'menu-item'; el.innerText = item.name;
                el.onclick = () => { openOverlay(item.name, item.bg, item.cond); };
                content.appendChild(el);
            });
        });

        L.DomEvent.disableScrollPropagation(document.getElementById('main-menu'));
        L.DomEvent.disableClickPropagation(document.getElementById('main-menu'));
    }

    function openOverlay(name, mainImg, condImg) {
        document.getElementById('info-name').innerText = name; 
        document.getElementById('info-main').src = mainImg; 
        document.getElementById('info-cond').src = condImg; 
        document.getElementById('overlay-info').style.display = 'flex'; 
    }

    userPings.forEach(p => createFinalMarker(p));
    updateUserLegend(); 
    setTimeout(initMenu, 300);
</script>
</body>
</html>
