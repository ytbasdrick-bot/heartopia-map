<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Maptopia FR - Version Int√©grale Heartopia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; 
            background: url('Heartopia.jpg') no-repeat center center fixed; 
            background-size: cover; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; 
        }

        /* --- √âCRAN D'ACCUEIL --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: black; z-index: 20000; display: flex; align-items: flex-end; 
            justify-content: center; transition: opacity 1s ease;
        }
        .video-bg-blur { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(20px) brightness(0.4); }
        #intro-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2; border-left: 2px solid #d4af37; border-right: 2px solid #d4af37; }
        .welcome-box { 
            position: relative; bottom: 8%; width: 85%; max-width: 450px; padding: 25px; 
            background: rgba(0, 0, 0, 0.85); border: 2px solid #d4af37; border-radius: 20px; 
            color: white; z-index: 10; backdrop-filter: blur(10px); text-align: center; 
        }
        #enter-button { padding: 15px 35px; background: linear-gradient(135deg, #8b0000, #d4af37); color: white; border: 1px solid white; border-radius: 50px; font-size: 17px; font-weight: bold; cursor: pointer; }

        /* --- CARTE --- */
        #map { height: 100vh; width: 100vw; opacity: 0; transition: opacity 2s ease; background: transparent !important; }

        /* --- MENU ACCORD√âON --- */
        .leaflet-control-layers {
            left: 20px !important; top: 20px !important; width: 280px !important;
            background: rgba(255, 255, 255, 0.98) !important; border-radius: 15px !important; 
            padding: 10px !important; box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
            max-height: 75vh; overflow-y: auto; border: none !important; z-index: 1000;
        }
        
        .accordion-title { 
            color: white; padding: 12px; border-radius: 10px; cursor: pointer; 
            font-weight: bold; margin-bottom: 6px; display: flex; justify-content: space-between; 
            align-items: center; font-size: 13px; text-transform: uppercase;
        }
        .title-pnj { background: #8b0000; }
        .title-bus { background: #2980b9; }
        .title-shop { background: #9b59b6; }
        .title-lieux { background: #27ae60; }
        .title-poisson { background: #f39c12; }
        
        .accordion-content { display: none; background: white; border-radius: 0 0 10px 10px; border: 1px solid #eee; border-top: none; }
        .accordion-content.active { display: block; }
        
        .menu-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f0f0f0; color: #333; }
        .menu-item:hover { background: #f9f9f9; }
        .menu-icon { width: 26px; height: 26px; margin-right: 12px; border-radius: 50%; object-fit: contain; }

        /* --- UI ELEMENTS --- */
        .team-container { position: fixed; bottom: 75px; left: 20px; z-index: 4000; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 15px; border: 2px solid #d4af37; cursor: pointer; text-align: center; backdrop-filter: blur(5px); }
        .team-name-label { color: #d4af37; font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .team-logo { width: 160px; border-radius: 8px; }
        .discord-btn { position: fixed; bottom: 80px; right: 20px; z-index: 4000; }
        .discord-icon { width: 65px; }

        #overlay-fish, #overlay-group { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 30000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .full-img { max-width: 90%; max-height: 75vh; border: 4px solid #d4af37; border-radius: 15px; }
        
        .footer-wiki { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; z-index: 3000; background: linear-gradient(90deg, #8b0000, #d4af37, #8b0000); display: flex; justify-content: center; align-items: center; border-top: 2px solid white; }
        .wiki-link { text-decoration: none; color: white; font-weight: bold; text-align: center; }

        /* Style des labels sur la carte */
        .label-ville { background: white !important; border: 2px solid #3498db !important; border-radius: 5px; padding: 2px 8px; font-weight: bold; font-size: 11px; color: #2980b9; text-align: center; pointer-events: none; }
        .label-eau { background: rgba(255, 255, 255, 0.9) !important; border: 2px solid #2980b9 !important; border-radius: 20px; padding: 2px 10px; color: #01579b; font-size: 10px; font-weight: bold; pointer-events: none; }

        @media (max-width: 768px) {
            .leaflet-control-layers { width: 240px !important; left: 10px !important; top: 10px !important; }
            .team-container { bottom: 65px !important; left: 10px !important; transform: scale(0.8); transform-origin: left bottom; }
        }
    </style>
</head>
<body>

<div id="intro-screen">
    <video class="video-bg-blur" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>
    <video id="intro-video" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>
    <div class="welcome-box">
        <h1>MAPTOPIA FR</h1>
        <p>Explorez Heartopia avec notre carte interactive.</p>
        <button id="enter-button" onclick="startExperience()">üéÑ ENTRER üéÑ</button>
    </div>
</div>

<div id="map"></div>

<div class="team-container" onclick="showGroupImage()">
    <div class="team-name-label">TEAM HEARTFR</div>
    <img src="groupefr.png" class="team-logo">
</div>

<a href="https://discord.gg/dc8eZwf2jq" target="_blank" class="discord-btn">
    <img src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" class="discord-icon">
</a>

<div id="overlay-group" onclick="this.style.display='none'"><img src="groupefr.png" class="full-img"></div>
<div id="overlay-fish" onclick="this.style.display='none'"><img id="fish-main" class="full-img" style="border-bottom:none"><img id="fish-cond" class="full-img" style="border-top:none; background:white; max-height:160px; width:90%; object-fit:contain;"></div>

<div class="footer-wiki">
    <a href="https://jayibwi.wixsite.com/my-site-1" target="_blank" class="wiki-link">üìñ WIKI FR COMPLET üìñ</a>
</div>

<script>
    function startExperience() {
        document.getElementById('intro-screen').style.opacity = '0';
        document.getElementById('map').style.opacity = '1';
        setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);
    }

    function showGroupImage() { document.getElementById('overlay-group').style.display = 'flex'; }

    var bounds = [[-1000, 0], [0, 1000]];
    var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1, maxBounds: bounds });
    L.imageOverlay('carte.png', bounds).addTo(map);
    map.setView([-500, 500], 1);

    var currentActiveLayer = null;
    var dataStorage = {};

    function clearPrevious() { if(currentActiveLayer) { map.removeLayer(currentActiveLayer); currentActiveLayer = null; } }

    function register(cat, pos, name, img, options = {}) {
        var g = L.layerGroup();
        if(options.type) { 
            L.marker(pos, {opacity:0}).addTo(g).bindTooltip(name, {permanent:true, direction:'center', className:options.type}); 
        } else { 
            var size = (cat === 'shop') ? 60 : 70;
            L.marker(pos, {icon: L.icon({iconUrl:img, iconSize:[size,size], iconAnchor:[size/2,size]})}).addTo(g).bindPopup(name); 
        }
        
        // Si startOn est true, on l'affiche direct sans passer par currentActiveLayer (pour les lieux)
        if(options.startOn) {
            g.addTo(map);
        }

        if(!dataStorage[cat]) dataStorage[cat] = [];
        dataStorage[cat].push({name:name, pos:pos, layer:g, img:img, startOn: options.startOn});
    }

    // --- DONN√âES PNJ ---
    var pnjs = [["Bob",[-471,501],'pnj/bob.png'], ["Atara",[-526,499],'pnj/atara.png'], ["Le Collectionneur",[-478,493],'pnj/collectioneur.png'], ["Doroth√©e",[-469,488],'pnj/doroth√©e.png'], ["Massimo",[-446,493],'pnj/massimo.png'], ["Ka Ching",[-412,418],'pnj/ka ching.png'], ["Andrew",[-399,591],'pnj/andrew.png'], ["Eric",[-259,522],'pnj/eric.png'], ["Vanya",[-456,549],'pnj/vanya.png'], ["Naniwa",[-502,582],'pnj/niniwa.png'], ["Joan",[-502,519],'pnj/joa.png'], ["Will",[-807,419],'pnj/will.png'], ["Patti",[-355,809],'pnj/patti.png'], ["Vernie",[-653,225],'pnj/vernie.png'], ["Bayley",[-498,526],'pnj/bayley.png']];
    pnjs.forEach(p => register('pnj', p[1], p[0], p[2]));

    // --- DONN√âES BUS ---
    var buses = [["Banlieue Ouest",[-533,340]], ["Banlieue du Village",[-519,639]], ["Village de P√™cheurs",[-654,479]], ["Champ de Fleurs",[-532,218]], ["Montagne Thermale",[-222,512]], ["Banlieue Nord",[-373,480]], ["Place Centrale",[-497,481]], ["For√™t",[-500,798]]];
    buses.forEach(b => register('bus', b[1], b[0], 'bus.png'));

    // --- DONN√âES LIEUX & MAGASINS (Tes donn√©es exactes) ---
    var lieuxData = [
        { pos: [-538, 492], name: "Place Centrale", type: "label-ville", startOn: true },
        { pos: [-692, 506], name: "Village de P√™cheurs", type: "label-ville", startOn: true },
        { pos: [-438, 513], name: "Village", type: "label-ville", startOn: true },
        { pos: [-649, 185], name: "Champ de Fleurs", type: "label-ville", startOn: true },
        { pos: [-440, 184], name: "Montagne de Baleine", type: "label-ville", startOn: true },
        { pos: [-184, 291], name: "Les Ruines", type: "label-ville", startOn: true },
        { pos: [-223, 501], name: "Montagne Thermale", type: "label-ville", startOn: true },
        { pos: [-228, 627], name: "Falaise Rocheuse", type: "label-ville", startOn: true },
        { pos: [-531, 805], name: "For√™t de Ch√™nes Spirituels", type: "label-ville", startOn: true },
        { pos: [-494, 429], name: "Rue des Arts", type: "label-ville", startOn: true },
        { pos: [-510, 558], name: "Rue du Jardin", type: "label-ville", startOn: true },
        { pos: [-736, 602], name: "Quai Oriental", type: "label-ville", startOn: true },
        { pos: [-690, 402], name: "Quai", type: "label-ville", startOn: true },
        { pos: [-780, 387], name: "Phare", type: "label-ville", startOn: true },
        { pos: [-691, 783], name: "Tremplin", type: "label-ville", startOn: true },
        { pos: [-338, 933], name: "√éle de la For√™t", type: "label-ville", startOn: true },
        { pos: [-587, 406], name: "Banlieue", type: "label-ville", startOn: true },
        { pos: [-725, 208], name: "Plage Violette", type: "label-ville", startOn: true },
        { pos: [-783, 478], name: "Mer Calme", type: "label-eau", startOn: true },
        { pos: [-534, 92], name: "Mer de Baleine", type: "label-eau", startOn: true },
        { pos: [-68, 497], name: "Ancienne Mer", type: "label-eau", startOn: true },
        { pos: [-536, 232], name: "Lac dans la Prairie", type: "label-eau", startOn: true },
        { pos: [-337, 319], name: "Rivi√®re Aurore", type: "label-eau", startOn: true },
        { pos: [-176, 394], name: "Lac Volcanique", type: "label-eau", startOn: true },
        { pos: [-265, 537], name: "Lac Thermale", type: "label-eau", startOn: true },
        { pos: [-344, 652], name: "Rivi√®re Peu Profonde", type: "label-eau", startOn: true },
        { pos: [-598, 748], name: "Lac de la For√™t", type: "label-eau", startOn: true },
        { pos: [-431, 774], name: "Lac de la For√™t (Haut)", type: "label-eau", startOn: true },
        { pos: [-608, 481], name: "Lac de Banlieue", type: "label-eau", startOn: true },
        { pos: [-669, 368], name: "Rivi√®re Calme", type: "label-eau", startOn: true },
        { pos: [-674, 627], name: "Fleuve d'Arbres G√©ants", type: "label-eau", startOn: true },
        { pos: [-472, 487], name: "Magasin de V√™tement", icon: 'vetement.png', isShop: true, startOn: false },
        { pos: [-474, 503], name: "Magasin de Meuble", icon: 'Meuble.png', isShop: true, startOn: false },
        { pos: [-496, 523], name: "Magasin Animaux", icon: 'chien.png', isShop: true, startOn: false },
        { pos: [-440, 467], name: "Librairie", icon: 'Librairie.png', isShop: true, startOn: false }
    ];

    lieuxData.forEach(l => {
        var cat = l.isShop ? 'shop' : 'lieux';
        register(cat, l.pos, l.name, l.icon || '', {type: l.type, startOn: l.startOn});
    });

    var fishList = [{name:"Ablette", m:"poisson/ablette1.png", c:"poisson/Lacs.png"}];

    // --- MENU ---
    var customControl = L.control({position: 'topleft'});
    customControl.onAdd = function() {
        var div = L.DomUtil.create('div', 'leaflet-control-layers');
        div.innerHTML = `
            <div id="c-pnj"><div class="accordion-title title-pnj">üë• PERSONNAGES <span>‚ñº</span></div><div class="accordion-content"></div></div>
            <div id="c-bus"><div class="accordion-title title-bus">üöå ARR√äTS DE BUS <span>‚ñº</span></div><div class="accordion-content"></div></div>
            <div id="c-shop"><div class="accordion-title title-shop">üõçÔ∏è MAGASINS <span>‚ñº</span></div><div class="accordion-content"></div></div>
            <div id="c-lieux"><div class="accordion-title title-lieux">üìç LIEUX <span>‚ñº</span></div><div class="accordion-content"></div></div>
            <div id="c-fish"><div class="accordion-title title-poisson">üêü GUIDE DE P√äCHE <span>‚ñº</span></div><div class="accordion-content"></div></div>
        `;
        return div;
    };
    customControl.addTo(map);

    function initMenu() {
        ['pnj','bus','shop','lieux'].forEach(cat => {
            var container = document.getElementById('c-'+cat);
            var content = container.querySelector('.accordion-content');
            var title = container.querySelector('.accordion-title');
            dataStorage[cat].forEach(item => {
                var el = document.createElement('div');
                el.className = 'menu-item';
                el.innerHTML = (item.img ? `<img src="${item.img}" class="menu-icon">` : 'üìç ') + item.name;
                el.onclick = () => {
                    if(!item.startOn) { // Si c'est un truc qui n'est pas d√©j√† affich√©
                        clearPrevious();
                        item.layer.addTo(map);
                        currentActiveLayer = item.layer;
                    }
                    map.flyTo(item.pos, 2, {duration: 1.2});
                    content.classList.remove('active');
                    title.querySelector('span').innerHTML = '‚ñº';
                };
                content.appendChild(el);
            });
            title.onclick = () => { 
                content.classList.toggle('active'); 
                title.querySelector('span').innerHTML = content.classList.contains('active') ? '‚ñ≤' : '‚ñº'; 
            };
        });

        var fCont = document.querySelector('#c-fish .accordion-content');
        var fTit = document.querySelector('#c-fish .accordion-title');
        fishList.forEach(f => {
            var el = document.createElement('div'); el.className = 'menu-item'; el.innerHTML = 'üêü ' + f.name;
            el.onclick = () => {
                document.getElementById('fish-main').src = f.m;
                document.getElementById('fish-cond').src = f.c;
                document.getElementById('overlay-fish').style.display = 'flex';
            };
            fCont.appendChild(el);
        });
        fTit.onclick = () => { fCont.classList.toggle('active'); fTit.querySelector('span').innerHTML = fCont.classList.contains('active') ? '‚ñ≤' : '‚ñº'; };
    }
    setTimeout(initMenu, 300);
</script>
</body>
</html>
