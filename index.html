<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive Heartopia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #5da0c2; overflow: hidden; position: relative; }
        
        /* Filigrane By Asdrick_TikTok */
        .watermark-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; opacity: 0.2;
            overflow: hidden; display: flex; flex-wrap: wrap; justify-content: space-around;
        }
        .watermark-box { display: flex; flex-direction: column; align-items: center; transform: rotate(-35deg); padding: 50px; user-select: none; }
        .wm-user { font-family: 'Arial', sans-serif; color: black; font-size: 11px; font-weight: bold; }
        .wm-heartopia {
            font-family: 'Arial Black', sans-serif; font-size: 16px;
            background: linear-gradient(to right, #ff6b6b, #f06292, #ba68c8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        #map { height: 100vh; width: 100vw; background: transparent !important; z-index: 10; }

        .label-ville {
            background: transparent !important; border: none !important; box-shadow: none !important;
            font-size: 11px; font-weight: bold; color: rgba(44, 62, 80, 0.9);
            text-shadow: 1px 1px 2px white; text-transform: uppercase; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="watermark-container" id="watermark"></div>
    <div id="map"></div>

    <script>
        // --- GÉNÉRATION DU FILIGRANE ---
        const watermarkContainer = document.getElementById('watermark');
        for (let i = 0; i < 80; i++) {
            const box = document.createElement('div');
            box.className = 'watermark-box';
            box.innerHTML = `<span class="wm-user">By Asdrick_TikTok</span><span class="wm-heartopia">Heartopia</span>`;
            watermarkContainer.appendChild(box);
        }

        // --- CONFIGURATION DE LA CARTE ---
        var map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: 0, 
            maxZoom: 5,
            zoom: 1 
        });

        var bounds = [[-1000, 0], [0, 1000]];
        L.imageOverlay('carte.png', bounds).addTo(map);
        map.setView([-500, 500], 1);

        // --- GROUPES DE CALQUES ---
        var groupePNJ = L.layerGroup().addTo(map);
        var groupeLieux = L.layerGroup().addTo(map);
        var groupeBus = L.layerGroup().addTo(map);
        var groupeCommerces = L.layerGroup().addTo(map);

        // --- GESTION DU ZOOM (STABLE) ---
        function updateVisibility() {
            var z = map.getZoom();
            if (z < 1) {
                if (map.hasLayer(groupePNJ)) map.removeLayer(groupePNJ);
                if (map.hasLayer(groupeBus)) map.removeLayer(groupeBus);
                if (map.hasLayer(groupeCommerces)) map.removeLayer(groupeCommerces);
            } else {
                if (!map.hasLayer(groupePNJ)) map.addLayer(groupePNJ);
                if (!map.hasLayer(groupeBus)) map.addLayer(groupeBus);
                if (!map.hasLayer(groupeCommerces)) map.addLayer(groupeCommerces);
            }
        }
        map.on('zoomend', updateVisibility);

        // --- ICONS ET DONNÉES ---
        function createIcon(url, size = 60) {
            return L.icon({ iconUrl: url, iconSize: [size, size], iconAnchor: [size/2, size], popupAnchor: [0, -size] });
        }

        var icons = {
            bob: 'bob.png', atara: 'atara.png', coll: 'collectioneur.png', doro: 'dorothée.png',
            mass: 'massimo.png', anni: 'annie.png', kach: 'ka ching.png', andr: 'andrew.png',
            eric: 'eric.png', vany: 'vanya.png', nani: 'niniwa.png', joan: 'joa.png',
            bail: 'bayley.png', will: 'will.png', patti: 'patti.png', vernie: 'vernie.png',
            bus: 'bus.png', coif: 'coiffeur.png', meub: 'Meuble.png', anim: 'chien.png',
            vet: 'vetement.png', libr: 'Librairie.png'
        };

        var pnjData = [
            { pos: [-471, 501], name: "Bob", icon: icons.bob },
            { pos: [-526, 499], name: "Atara", icon: icons.atara },
            { pos: [-478, 493], name: "Le Collectionneur", icon: icons.coll },
            { pos: [-469, 488], name: "Dorothée", icon: icons.doro },
            { pos: [-446, 493], name: "Massimo", icon: icons.mass },
            { pos: [-500, 500], name: "Annie", icon: icons.anni },
            { pos: [-412, 418], name: "Ka Ching", icon: icons.kach },
            { pos: [-399, 591], name: "Andrew", icon: icons.andr },
            { pos: [-259, 522], name: "Eric", icon: icons.eric },
            { pos: [-456, 549], name: "Vanya", icon: icons.vany },
            { pos: [-502, 582], name: "Naniwa", icon: icons.nani },
            { pos: [-502, 519], name: "Joan", icon: icons.joan },
            { pos: [-498, 528], name: "Bailey", icon: icons.bail },
            { pos: [-807, 419], name: "Will", icon: icons.will },
            { pos: [-355, 809], name: "Patti", icon: icons.patti },
            { pos: [-653, 225], name: "Vernie", icon: icons.vernie }
        ];

        pnjData.forEach(p => L.marker(p.pos, {icon: createIcon(p.icon)}).addTo(groupePNJ).bindPopup(p.name));

        var commerceData = [
            { pos: [-470, 486], name: "Coiffeur", icon: icons.coif },
            { pos: [-471, 504], name: "Magasin de meubles", icon: icons.meub },
            { pos: [-497, 520], name: "Magasin d'animaux", icon: icons.anim },
            { pos: [-470, 488], name: "Magasin de vêtements", icon: icons.vet },
            { pos: [-438, 467], name: "Librairie", icon: icons.libr }
        ];

        commerceData.forEach(c => L.marker(c.pos, {icon: createIcon(c.icon, 35)}).addTo(groupeCommerces).bindPopup(c.name));

        var busCoords = [
            { pos: [-533, 340], name: "Banlieue Ouest" },
            { pos: [-519, 639], name: "Banlieue du village" },
            { pos: [-654, 479], name: "Village de pecheurs" },
            { pos: [-532, 218], name: "Champ de fleurs" },
            { pos: [-222, 512], name: "Montagne thermale" },
            { pos: [-373, 480], name: "Banlieue nord du village" },
            { pos: [-497, 481], name: "Place centrale" },
            { pos: [-500, 798], name: "Forêt" }
        ];

        busCoords.forEach(b => L.marker(b.pos, {icon: createIcon(icons.bus, 90)}).addTo(groupeBus).bindPopup(b.name));

        function addLabel(coords, text) {
            L.marker(coords, { opacity: 0 }).addTo(groupeLieux)
             .bindTooltip(text, { permanent: true, direction: 'center', className: 'label-ville' });
        }
        addLabel([-538, 492], "PLACE CENTRALE");
        addLabel([-666, 429], "QUAI");
        addLabel([-539, 947], "MER DE L'EST");
        addLabel([-535, 75], "MER DE BALEINE");
        addLabel([-78, 499], "ANCIENNE MER");
        addLabel([-783, 478], "MER CALME");

        var overlays = { 
            "Personnages": groupePNJ, 
            "Commerces": groupeCommerces, 
            "Lieux": groupeLieux, 
            "Bus": groupeBus
        };
        L.control.layers(null, overlays, {collapsed: false}).addTo(map);

        map.on('click', e => {
            L.popup().setLatLng(e.latlng).setContent("["+Math.round(e.latlng.lat)+", "+Math.round(e.latlng.lng)+"]").openOn(map);
        });
    </script>
</body>
</html>
