<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Maptopia FR - Rex Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; background: url('Heartopia.jpg') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }

        /* INTRO */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 20000; display: flex; align-items: flex-end; justify-content: center; transition: opacity 1s ease; }
        .video-bg-blur { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(20px) brightness(0.4); }
        #intro-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2; border-left: 2px solid #d4af37; border-right: 2px solid #d4af37; }
        .welcome-box { position: relative; bottom: 8%; width: 500px; padding: 30px; background: rgba(0, 0, 0, 0.85); border: 2px solid #d4af37; border-radius: 20px; color: white; z-index: 10; backdrop-filter: blur(10px); text-align: center; }
        #enter-button { padding: 15px 45px; background: linear-gradient(135deg, #8b0000, #d4af37); color: white; border: 1px solid white; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }

        /* MAP & UI */
        #map { height: 100vh; width: 100vw; opacity: 0; transition: opacity 2s ease; background: transparent !important; }
        .leaflet-control-layers { left: 20px !important; top: 20px !important; width: 260px !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 15px !important; padding: 10px !important; max-height: 80vh; overflow-y: auto !important; border: none !important; box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important; pointer-events: auto !important; }
        
        .accordion-title { color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; text-align: center; font-size: 12px; text-transform: uppercase; }
        .title-pnj { background: #8b0000; } .title-bus { background: #2980b9; } .title-shop { background: #9b59b6; } .title-lieux { background: #27ae60; } .title-poisson { background: #f39c12; }
        .accordion-content { display: none; margin-bottom: 10px; } .accordion-content.active { display: block; }
        .menu-item { display: flex; align-items: center; padding: 8px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #eee; color: #333; }
        .menu-item:hover { background: #f0f0f0; }

        /* LÃ‰GENDE PINGS */
        .ping-legend { position: fixed; right: 20px; top: 20px; width: 240px; background: rgba(0,0,0,0.9); border: 2px solid #d4af37; border-radius: 15px; padding: 15px; color: white; z-index: 1000; max-height: 45vh; display: flex; flex-direction: column; pointer-events: auto; }
        #legend-list { overflow-y: auto; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 6px; border-radius: 6px; }
        .legend-info { display: flex; align-items: center; cursor: pointer; flex-grow: 1; overflow: hidden; }
        .btn-delete-small { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px; margin-left: 5px; }

        /* LABELS CARTE */
        .label-ville { background: white !important; border: 2px solid #3498db !important; border-radius: 5px; padding: 2px 8px; font-weight: bold; font-size: 11px; color: #2980b9; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; }
        .label-eau { background: rgba(41, 128, 185, 0.7) !important; border: 1px solid #fff !important; border-radius: 5px; padding: 2px 8px; font-size: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; text-align: center; }

        /* OVERLAY POISSON */
        #overlay-fish { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: none; align-items: center; justify-content: center; }
        .fish-card { display: flex; flex-direction: column; align-items: center; background: white; padding: 25px; border-radius: 20px; border: 3px solid #d4af37; width: 450px; max-width: 90%; text-align: center; }
        .fish-img-container { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .fish-img-container img { width: 100% !important; height: auto; display: block; }
        #fish-main { mix-blend-mode: multiply; }

        .footer-wiki { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; z-index: 3000; background: linear-gradient(90deg, #8b0000, #d4af37, #8b0000); display: flex; align-items: center; justify-content: center; border-top: 3px solid white; }
        .footer-wiki a { color: white; text-decoration: none; font-weight: 900; font-size: 20px; text-transform: uppercase; }
        .team-box { position: fixed; bottom: 85px; left: 20px; z-index: 3000; text-align: center; }
        .team-img { width: 70px; height: 70px; border-radius: 15px; border: 2px solid #d4af37; cursor: pointer; }

        /* Ã‰DITEUR PING */
        .ping-editor { display: flex; flex-direction: column; gap: 8px; min-width: 170px; color: #333; }
        .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .choice-btn { border: 1px solid #ccc; border-radius: 5px; padding: 5px; cursor: pointer; text-align: center; font-size: 18px; background: white; }
        .choice-btn.selected { border: 2px solid #8b0000; background: #fff5f5; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 1px solid #999; }
        .color-dot.selected { border: 2px solid #000; transform: scale(1.1); }
    </style>
</head>
<body>

<audio id="main-audio"><source src="sonheartopia.mp4" type="audio/mp4"></audio>

<div id="intro-screen">
    <video class="video-bg-blur" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>
    <video id="intro-video" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>
    <div class="welcome-box">
        <h1>MAPTOPIA FR</h1>
        <button id="enter-button" onclick="startExperience()">ðŸŽ„ ENTRER ðŸŽ„</button>
    </div>
</div>

<div id="map"></div>

<div class="ping-legend" id="p-legend">
    <h3 style="text-align:center; color:#d4af37; font-size:13px; margin:0;">ðŸ“Œ MES RESSOURCES</h3>
    <div id="legend-list"></div>
</div>

<div class="team-box"><img src="groupefr.png" class="team-img" onclick="document.getElementById('overlay-team').style.display='flex'"></div>
<div id="overlay-team" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:40000; display:none; align-items:center; justify-content:center;" onclick="this.style.display='none'"><img src="groupefr.png" style="max-width:80%; border:4px solid #d4af37; border-radius:20px;"></div>

<div id="overlay-fish" onclick="this.style.display='none'">
    <div class="fish-card" onclick="event.stopPropagation()">
        <h2 id="fish-name" style="color:#333; margin-bottom:15px;"></h2>
        <div class="fish-img-container">
            <img id="fish-main" alt="Poisson">
            <img id="fish-cond" alt="Conditions">
        </div>
        <button onclick="document.getElementById('overlay-fish').style.display='none'" style="margin-top:20px; padding:10px 20px; cursor:pointer; background:#8b0000; color:white; border:none; border-radius:5px; font-weight:bold;">FERMER</button>
    </div>
</div>

<div class="footer-wiki"><a href="https://jayibwi.wixsite.com/my-site-1" target="_blank">ðŸ“– WIKI FR COMPLET ðŸ“–</a></div>

<script>
    const colors = { rouge: '#e74c3c', bleu: '#3498db', vert: '#2ecc71', jaune: '#f1c40f', violet: '#9b59b6', orange: '#e67e22' };
    const icons = { note: 'ðŸ“Œ', fish: 'ðŸŽ£', bird: 'ðŸ¦œ', bug: 'ðŸ¦‹', wood: 'ðŸŒ²', stone: 'â›°ï¸' };

    function startExperience() {
        document.getElementById('main-audio').play().catch(e => {});
        document.getElementById('intro-screen').style.opacity = '0';
        document.getElementById('map').style.opacity = '1';
        setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);
    }

    // --- CARTE ---
    var bounds = [[-1000, 0], [0, 1000]];
    var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1 });
    L.imageOverlay('carte.png', bounds).addTo(map);
    map.setView([-500, 500], 1);

    function disableMapInteraction(elementId) {
        var element = document.getElementById(elementId);
        if (element) {
            L.DomEvent.disableScrollPropagation(element);
            L.DomEvent.disableClickPropagation(element);
        }
    }

    // --- PINGS ---
    var userPings = JSON.parse(localStorage.getItem('maptopia_pings')) || [];
    var pingMarkers = {};

    function updateLegend() {
        const list = document.getElementById('legend-list');
        list.innerHTML = userPings.length ? "" : "<div style='font-size:10px;color:#aaa;text-align:center;'>Clic droit sur la carte</div>";
        userPings.forEach(p => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-info" onclick="map.flyTo([${p.latlng.lat}, ${p.latlng.lng}], 2)"><span style="color:${colors[p.color]};margin-right:8px;">${icons[p.icon]}</span><span style="font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px;">${p.text}</span></div><button class="btn-delete-small" onclick="removePing('${p.id}')">X</button>`;
            list.appendChild(item);
        });
        disableMapInteraction('p-legend');
    }

    function createPing(latlng, text, color, icon, isNew, id) {
        var mid = id || "id_" + Date.now();
        var markerHtml = `<div style="background:${colors[color]};width:28px;height:28px;border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.4)">${icons[icon]}</div>`;
        var marker = L.marker(latlng, {icon: L.divIcon({className:'', html:markerHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);
        pingMarkers[mid] = marker;
        if (isNew) {
            var div = document.createElement('div'); div.className = "ping-editor";
            div.innerHTML = `<input type="text" id="in-${mid}" placeholder="Nom..." style="padding:6px;width:100%;box-sizing:border-box;"><div class="icon-grid">${Object.entries(icons).map(([k,v]) => `<div class="choice-btn ${k==='note'?'selected':''}" onclick="selectIcon('${mid}','${k}',this)">${v}</div>`).join('')}</div><div style="display:flex;justify-content:space-between;margin-top:5px;">${Object.entries(colors).map(([k,v]) => `<div class="color-dot ${k==='bleu'?'selected':''}" style="background:${v}" onclick="selectColor('${mid}','${k}',this)"></div>`).join('')}</div><button onclick="confirmPing('${mid}',${latlng.lat},${latlng.lng})" style="margin-top:8px;background:#27ae60;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;width:100%;">VALIDER</button>`;
            marker.tempIcon = 'note'; marker.tempColor = 'bleu'; marker.bindPopup(div).openPopup();
        } else {
            marker.bindPopup(`<b>${icons[icon]} ${text}</b><br><button onclick="removePing('${mid}')" style="background:#e74c3c;color:white;border:none;width:100%;margin-top:8px;padding:5px;cursor:pointer;">Supprimer</button>`);
        }
    }
    window.selectIcon = (id, i, el) => { pingMarkers[id].tempIcon = i; el.parentElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); };
    window.selectColor = (id, c, el) => { pingMarkers[id].tempColor = c; el.parentElement.querySelectorAll('.color-dot').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); };
    window.confirmPing = (id, lat, lng) => { 
        var v = document.getElementById('in-'+id).value || "Note"; var icon = pingMarkers[id].tempIcon, color = pingMarkers[id].tempColor;
        userPings.push({id, latlng:{lat,lng}, text:v, color, icon}); localStorage.setItem('maptopia_pings', JSON.stringify(userPings));
        map.removeLayer(pingMarkers[id]); createPing({lat,lng}, v, color, icon, false, id); updateLegend();
    };
    window.removePing = (id) => { if(pingMarkers[id]) map.removeLayer(pingMarkers[id]); userPings = userPings.filter(p => String(p.id) !== String(id)); localStorage.setItem('maptopia_pings', JSON.stringify(userPings)); updateLegend(); };

    map.on('contextmenu', (e) => createPing(e.latlng, "", "bleu", "note", true));
    userPings.forEach(p => createPing(p.latlng, p.text, p.color, p.icon, false, p.id));
    updateLegend();

    // --- GESTION DES MARQUEURS ACTIFS (PNJ, BUS, SHOP) ---
    var currentActiveMarker = null;
    var dataStorage = { pnj:[], bus:[], shop:[], lieux:[] };

    function register(cat, pos, name, img, opts = {}) {
        let marker;
        if(opts.type) {
            // Pour les labels (Villes/Lacs), ils restent fixes
            marker = L.marker(pos, {opacity:0}).bindTooltip(name, {permanent:true, direction:'center', className:opts.type});
            if(opts.startOn) marker.addTo(map);
        } else {
            // Pour les PNJ, Bus, Shop
            marker = L.marker(pos, {
                icon: L.icon({
                    iconUrl: img, 
                    iconSize: [60, 60], 
                    iconAnchor: [30, 60], // Le pied de l'image est sur le point
                    popupAnchor: [0, -60] // Le popup s'affiche 60px au dessus de l'ancre
                })
            }).bindPopup(`<b>${name}</b>`);
        }
        dataStorage[cat].push({name, pos, marker});
    }

    // LISTES DONNÃ‰ES
    [ {pos:[-471,501], name:"Bob", icon:'pnj/bob.png'}, {pos:[-526,499], name:"Atara", icon:'pnj/atara.png'}, {pos:[-478,493], name:"Le Collectionneur", icon:'pnj/collectioneur.png'}, {pos:[-469,488], name:"DorothÃ©e", icon:'pnj/dorothÃ©e.png'}, {pos:[-446,493], name:"Massimo", icon:'pnj/massimo.png'}, {pos:[-412,418], name:"Ka Ching", icon:'pnj/ka ching.png'}, {pos:[-399,591], name:"Andrew", icon:'pnj/andrew.png'}, {pos:[-259,522], name:"Eric", icon:'pnj/eric.png'}, {pos:[-456,549], name:"Vanya", icon:'pnj/vanya.png'}, {pos:[-502,582], name:"Naniwa", icon:'pnj/niniwa.png'}, {pos:[-502,519], name:"Joan", icon:'pnj/joa.png'}, {pos:[-807,419], name:"Will", icon:'pnj/will.png'}, {pos:[-355,809], name:"Patti", icon:'pnj/patti.png'}, {pos:[-653,225], name:"Vernie", icon:'pnj/vernie.png'}, {pos:[-498,526], name:"Bayley", icon:'pnj/bayley.png'} ].forEach(p => register('pnj', p.pos, p.name, p.icon));

    [ ["Banlieue Ouest",[-533,340]], ["Banlieue Village",[-519,639]], ["Village PÃªcheurs",[-654,479]], ["Champ Fleurs",[-532,218]], ["Montagne Thermale",[-222,512]], ["Banlieue Nord",[-373,480]], ["Place Centrale",[-497,481]], ["ForÃªt",[-500,798]] ].forEach(b => register('bus', b[1], b[0], 'bus.png'));

    var lieuxData = [
        { pos: [-538, 492], name: "Place Centrale", type: "label-ville", startOn: true }, { pos: [-692, 506], name: "Village de PÃªcheurs", type: "label-ville", startOn: true }, { pos: [-438, 513], name: "Village", type: "label-ville", startOn: true }, { pos: [-649, 185], name: "Champ de Fleurs", type: "label-ville", startOn: true }, { pos: [-440, 184], name: "Montagne de Baleine", type: "label-ville", startOn: true }, { pos: [-184, 291], name: "Les Ruines", type: "label-ville", startOn: true }, { pos: [-223, 501], name: "Montagne Thermale", type: "label-ville", startOn: true }, { pos: [-228, 627], name: "Falaise Rocheuse", type: "label-ville", startOn: true }, { pos: [-531, 805], name: "ForÃªt de ChÃªnes Spirituels", type: "label-ville", startOn: true }, { pos: [-494, 429], name: "Rue des Arts", type: "label-ville", startOn: true }, { pos: [-510, 558], name: "Rue du Jardin", type: "label-ville", startOn: true }, { pos: [-736, 602], name: "Quai Oriental", type: "label-ville", startOn: true }, { pos: [-690, 402], name: "Quai", type: "label-ville", startOn: true }, { pos: [-780, 387], name: "Phare", type: "label-ville", startOn: true }, { pos: [-691, 783], name: "Tremplin", type: "label-ville", startOn: true }, { pos: [-338, 933], name: "ÃŽle de la ForÃªt", type: "label-ville", startOn: true }, { pos: [-587, 406], name: "Banlieue", type: "label-ville", startOn: true }, { pos: [-725, 208], name: "Plage Violette", type: "label-ville", startOn: true }, { pos: [-783, 478], name: "Mer Calme", type: "label-eau", startOn: true }, { pos: [-534, 92], name: "Mer de Baleine", type: "label-eau", startOn: true }, { pos: [-68, 497], name: "Ancienne Mer", type: "label-eau", startOn: true }, { pos: [-536, 232], name: "Lac dans la Prairie", type: "label-eau", startOn: true }, { pos: [-337, 319], name: "RiviÃ¨re Aurore", type: "label-eau", startOn: true }, { pos: [-176, 394], name: "Lac Volcanique", type: "label-eau", startOn: true }, { pos: [-265, 537], name: "Lac Thermale", type: "label-eau", startOn: true }, { pos: [-344, 652], name: "RiviÃ¨re Peu Profonde", type: "label-eau", startOn: true }, { pos: [-598, 748], name: "Lac de la ForÃªt", type: "label-eau", startOn: true }, { pos: [-431, 774], name: "Lac de la ForÃªt (Haut)", type: "label-eau", startOn: true }, { pos: [-608, 481], name: "Lac de Banlieue", type: "label-eau", startOn: true }, { pos: [-669, 368], name: "RiviÃ¨re Calme", type: "label-eau", startOn: true }, { pos: [-674, 627], name: "Fleuve d'Arbres GÃ©ants", type: "label-eau", startOn: true }, { pos: [-472, 487], name: "Magasin de VÃªtement", icon: 'vetement.png', isShop: true }, { pos: [-474, 503], name: "Magasin de Meuble", icon: 'Meuble.png', isShop: true }, { pos: [-496, 523], name: "Magasin Animaux", icon: 'chien.png', isShop: true }, { pos: [-440, 467], name: "Librairie", icon: 'Librairie.png', isShop: true }
    ];
    lieuxData.forEach(l => register(l.isShop ? 'shop' : 'lieux', l.pos, l.name, l.icon || '', {type: l.type, startOn: l.startOn}));

    const fishList = [
        { name: "Ablette", bg: "poisson/ablette1.png", cond: "poisson/Lacs.png" }, { name: "Acantharchus pomotis", bg: "poisson/Acantharchus_pomotis1.png", cond: "poisson/arcantharcus%20pomotis.png" }, { name: "Anguille europÃ©enne", bg: "VIDE", cond: "VIDE" }, { name: "Aphyosemion striatum", bg: "poisson/Aphyosemion%20striatum.png", cond: "poisson/Aphyosemion%20striatum1.png" }, { name: "Barbeau", bg: "poisson/barbeau1.png", cond: "poisson/barbeau.png" }, { name: "Barbillon", bg: "poisson/barbillon1.png", cond: "poisson/barbillon.png" }, { name: "Baudroie", bg: "poisson/baudroie1.png", cond: "poisson/Baudroie.png" }, { name: "Bernard l'Hermite", bg: "VIDE", cond: "poisson/bernardlhermite.png" }, { name: "Blennie de riviÃ¨re", bg: "VIDE", cond: "poisson/bleniiedesrivieree.png" }, { name: "Bonite", bg: "poisson/bonite1.png", cond: "poisson/bonite.png" }, { name: "Carpe argentÃ©e", bg: "poisson/carpe_argentee1.png", cond: "poisson/carpe_argentee.png" }, { name: "Carpe europÃ©enne", bg: "poisson/Carpe_europeenne1.png", cond: "poisson/Carpe_europeenne.png" }, { name: "Carpe Papillon", bg: "poisson/carpe%20papillon1.png", cond: "poisson/carpe%20papillon.png" }, { name: "Carpe noire", bg: "poisson/carpe%20noir.png", cond: "poisson/carpe%20noir1.png" }, { name: "Chabot", bg: "VIDE", cond: "poisson/chabot.png" }, { name: "ChimÃ¨re argentÃ©e", bg: "poisson/chimere%20argent1.pnj.avif", cond: "poisson/chimere%20argent%C3%A9.png" }, { name: "ComÃ¨te coussut", bg: "poisson/comete_coussut1.png", cond: "poisson/comete_coussut.png" }, { name: "Crabe de ruisseau", bg: "poisson/Crabe_de_ruisseau1.png", cond: "poisson/crabe%20de%20ruisseau.png" }, { name: "Crevette de la mer", bg: "VIDE", cond: "VIDE" }, { name: "Crevette verte", bg: "poisson/crevette_verte1.png", cond: "poisson/crevette%20verte.png" }, { name: "Ecrevisse noble", bg: "VIDE", cond: "VIDE" }, { name: "Ecrevisse noble bleue", bg: "VIDE", cond: "VIDE" }, { name: "Eglefin", bg: "VIDE", cond: "VIDE" }, { name: "Eperlan", bg: "VIDE", cond: "VIDE" }, { name: "Epinoche", bg: "VIDE", cond: "VIDE" }, { name: "Espadon", bg: "VIDE", cond: "VIDE" }, { name: "FÃ©ra", bg: "VIDE", cond: "VIDE" }, { name: "Grand black-basse", bg: "VIDE", cond: "VIDE" }, { name: "Grande huÃ®tre perliÃ¨re", bg: "VIDE", cond: "VIDE" }, { name: "Grenouille europÃ©enne", bg: "VIDE", cond: "VIDE" }, { name: "Gobie", bg: "VIDE", cond: "VIDE" }, { name: "Grondin perlon", bg: "VIDE", cond: "VIDE" }, { name: "Hippocampe", bg: "VIDE", cond: "VIDE" }, { name: "Huchon", bg: "VIDE", cond: "VIDE" }, { name: "Langouste europÃ©enne", bg: "VIDE", cond: "VIDE" }, { name: "Loche des fleurs", bg: "VIDE", cond: "VIDE" }, { name: "Loche des rochers", bg: "VIDE", cond: "VIDE" }, { name: "Lotte", bg: "VIDE", cond: "VIDE" }, { name: "Maquereau atlantique", bg: "VIDE", cond: "VIDE" }, { name: "Moule", bg: "VIDE", cond: "VIDE" }, { name: "Omble", bg: "VIDE", cond: "VIDE" }, { name: "Omble chevalier", bg: "VIDE", cond: "VIDE" }, { name: "Ombrine", bg: "VIDE", cond: "VIDE" }, { name: "Oranda", bg: "VIDE", cond: "VIDE" }, { name: "Pagellus bogaraveo", bg: "VIDE", cond: "VIDE" }, { name: "Perche de mer", bg: "VIDE", cond: "VIDE" }, { name: "Perche de prunier", bg: "VIDE", cond: "VIDE" }, { name: "Perche de riviÃ¨re", bg: "VIDE", cond: "VIDE" }, { name: "Pieuvre", bg: "VIDE", cond: "VIDE" }, { name: "Pieuvre naine atlantique", bg: "VIDE", cond: "VIDE" }, { name: "POISSON-TIGRE", bg: "VIDE", cond: "VIDE" }, { name: "Plie europÃ©enne", bg: "VIDE", cond: "VIDE" }, { name: "Poisson agrion", bg: "VIDE", cond: "VIDE" }, { name: "Poisson-clown", bg: "VIDE", cond: "VIDE" }, { name: "Poisson combattant", bg: "VIDE", cond: "VIDE" }, { name: "Poisson divin", bg: "VIDE", cond: "VIDE" }, { name: "Poisson Ã©pineux", bg: "VIDE", cond: "VIDE" }, { name: "Poisson-globe", bg: "VIDE", cond: "VIDE" }, { name: "Poisson-lion", bg: "VIDE", cond: "VIDE" }, { name: "Poisson lune", bg: "VIDE", cond: "VIDE" }, { name: "Poisson rouge", bg: "VIDE", cond: "VIDE" }, { name: "Poisson ruban", bg: "VIDE", cond: "VIDE" }, { name: "Poisson suspendu", bg: "VIDE", cond: "VIDE" }, { name: "Poisson Ã  yeux rouges", bg: "VIDE", cond: "VIDE" }, { name: "RÃ©galec", bg: "VIDE", cond: "VIDE" }, { name: "Requin baleine", bg: "VIDE", cond: "VIDE" }, { name: "Requin mako", bg: "VIDE", cond: "VIDE" }, { name: "Requin marteau", bg: "VIDE", cond: "VIDE" }, { name: "Rouget barbet", bg: "VIDE", cond: "VIDE" }, { name: "Roussette", bg: "VIDE", cond: "VIDE" }, { name: "Sandre blanc", bg: "VIDE", cond: "VIDE" }, { name: "Saumon atlantique", bg: "VIDE", cond: "VIDE" }, { name: "Saumon kÃ©ta", bg: "VIDE", cond: "VIDE" }, { name: "Saurel", bg: "VIDE", cond: "VIDE" }, { name: "Sardine", bg: "VIDE", cond: "VIDE" }, { name: "Seiche europÃ©enne", bg: "VIDE", cond: "VIDE" }, { name: "Silure europÃ©en", bg: "VIDE", cond: "VIDE" }, { name: "Tanche dorÃ©e", bg: "VIDE", cond: "VIDE" }, { name: "TÃªtard", bg: "VIDE", cond: "VIDE" }, { name: "Thon rouge", bg: "VIDE", cond: "VIDE" }, { name: "Tilapia", bg: "VIDE", cond: "VIDE" }, { name: "Tortue verte", bg: "VIDE", cond: "VIDE" }, { name: "Turbot", bg: "VIDE", cond: "VIDE" }, { name: "Vairon", bg: "VIDE", cond: "VIDE" }, { name: "Zingel streber", bg: "VIDE", cond: "VIDE" }
    ];

    // --- INITIALISATION MENU ---
    var menuCtrl = L.control({position: 'topleft'});
    menuCtrl.onAdd = () => {
        var div = L.DomUtil.create('div', 'leaflet-control-layers');
        div.id = "main-menu";
        div.innerHTML = `<div id="c-pnj"><div class="accordion-title title-pnj">PNJ</div><div class="accordion-content"></div></div><div id="c-bus"><div class="accordion-title title-bus">BUS</div><div class="accordion-content"></div></div><div id="c-shop"><div class="accordion-title title-shop">MAGASINS</div><div class="accordion-content"></div></div><div id="c-lieux"><div class="accordion-title title-lieux">LIEUX</div><div class="accordion-content"></div></div><div id="c-fish"><div class="accordion-title title-poisson">POISSONS</div><div class="accordion-content"></div></div>`;
        return div;
    };
    menuCtrl.addTo(map);

    function initMenu() {
        ['pnj','bus','shop','lieux'].forEach(cat => {
            var box = document.getElementById('c-'+cat), content = box.querySelector('.accordion-content');
            dataStorage[cat].forEach(item => {
                var el = document.createElement('div'); el.className = 'menu-item';
                el.innerHTML = item.name;
                el.onclick = () => {
                    // Si ce n'est pas un label de ville (qui eux sont permanents)
                    if (!item.marker.options.tooltip) {
                        // Supprime l'ancien marqueur actif s'il existe
                        if (currentActiveMarker) map.removeLayer(currentActiveMarker);
                        
                        // Affiche le nouveau et le mÃ©morise
                        item.marker.addTo(map);
                        currentActiveMarker = item.marker;
                    }
                    
                    map.flyTo(item.pos, 2);
                    if(item.marker.getPopup()) setTimeout(() => item.marker.openPopup(), 300);
                };
                content.appendChild(el);
            });
            box.querySelector('.accordion-title').onclick = () => content.classList.toggle('active');
        });

        var fCont = document.querySelector('#c-fish .accordion-content');
        fishList.forEach(f => {
            var el = document.createElement('div'); el.className = 'menu-item'; el.innerText = f.name;
            el.onclick = () => {
                document.getElementById('fish-name').innerText = f.name;
                document.getElementById('fish-main').src = f.bg;
                document.getElementById('fish-cond').src = f.cond;
                document.getElementById('overlay-fish').style.display = 'flex';
            };
            fCont.appendChild(el);
        });
        document.querySelector('#c-fish .accordion-title').onclick = () => fCont.classList.toggle('active');
        disableMapInteraction('main-menu');
    }
    setTimeout(initMenu, 300);
</script>
</body>
</html>
