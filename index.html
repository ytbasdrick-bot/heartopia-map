<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Maptopia - Rex System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; background: url('Heartopia.jpg') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100vw; opacity: 0; transition: opacity 2s ease; background: url('Heartopia.jpg') no-repeat center center !important; background-size: cover !important; }
        
        /* Ã‰cran d'accueil */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('Heartopia.jpg') no-repeat center center; background-size: cover; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease; }
        #intro-screen::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); }
        
        .lang-picker { position: relative; display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; z-index: 20002; }
        .flag { font-size: 35px; cursor: pointer; filter: grayscale(1); transition: 0.3s; padding: 5px; border-radius: 10px; }
        .flag.active { filter: grayscale(0); transform: scale(1.2); border: 2px solid #d4af37; background: rgba(212, 175, 55, 0.2); }

        .heartopia-title { position: relative; font-size: 55px; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; background: linear-gradient(to bottom, #fff 20%, #d4af37 50%, #8b6b15 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.8)); font-family: 'Arial Black', sans-serif; z-index: 20001; }
        .welcome-box { position: relative; width: 90%; max-width: 550px; padding: 40px; background: rgba(0, 0, 0, 0.85); border: 2px solid #d4af37; border-radius: 25px; color: white; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
        .details-list { text-align: left; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin: 25px 0; font-size: 14px; border-left: 4px solid #d4af37; line-height: 1.6; }
        #enter-button { padding: 18px 60px; background: linear-gradient(135deg, #8b0000, #d4af37); color: white; border: 2px solid white; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; }

        /* Menu */
        .leaflet-container { background: transparent !important; }
        .leaflet-control-layers { left: 20px !important; top: 20px !important; width: 180px !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 15px !important; padding: 8px !important; max-height: 85vh; overflow-y: auto !important; border: none !important; box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important; }
        .accordion-title { color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; text-align: center; font-size: 11px; text-transform: uppercase; }
        .title-pnj { background: #8b0000; } .title-bus { background: #2980b9; } .title-shop { background: #9b59b6; } .title-lieux { background: #27ae60; } .title-poisson { background: #f39c12; } .title-insecte { background: #2ecc71; }
        .accordion-content { display: none; margin-bottom: 10px; background: #fff; }
        .accordion-content.active { display: block; }
        .menu-item { padding: 8px 10px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee; color: #333; transition: background 0.2s; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .menu-item:hover { background: #f9f9f9; }

        /* LÃ©gende & Compteur */
        .ping-legend { position: fixed; right: 20px; top: 20px; width: 220px; background: rgba(0,0,0,0.9); border: 2px solid #d4af37; border-radius: 15px; padding: 15px; color: white; z-index: 1000; max-height: 65vh; display: flex; flex-direction: column; }
        #legend-list { overflow-y: auto; margin-top: 10px; flex-grow: 1; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 8px; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .visit-counter { margin-top: 15px; padding-top: 10px; border-top: 1px solid #d4af37; text-align: center; }
        .visit-counter p { font-size: 9px; color: #d4af37; margin-bottom: 8px; letter-spacing: 1px; font-weight: bold; }

        /* Labels fixes */
        .label-ville { background: white !important; border: 2px solid #3498db !important; border-radius: 5px; padding: 2px 8px; font-weight: bold; font-size: 11px; color: #2980b9; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .label-eau { background: rgba(41, 128, 185, 0.8) !important; border: 1px solid #fff !important; border-radius: 5px; padding: 2px 8px; font-size: 10px; color: white; font-weight: bold; white-space: nowrap; }
        .invisible-marker { background: transparent !important; border: none !important; }

        /* Footer & Discord */
        .footer-wiki { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; z-index: 3000; background: linear-gradient(90deg, #8b0000, #d4af37, #8b0000); display: flex; align-items: center; justify-content: center; border-top: 3px solid white; }
        .footer-wiki a { color: white; text-decoration: none; font-weight: 900; font-size: 20px; }
        #discord-link { position: fixed; bottom: 85px; right: 20px; z-index: 4000; }
        #discord-img { width: 60px; }

        /* Info Overlay */
        #overlay-info { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: none; align-items: center; justify-content: center; }
        .info-card { background: white; padding: 25px; border-radius: 20px; border: 3px solid #d4af37; width: 450px; text-align: center; }
        .info-card img { width: 100%; display: block; margin: 0 auto; }
        .info-img-main { mix-blend-mode: multiply; margin-bottom: 10px; }
    </style>
</head>
<body>

<audio id="main-audio"><source src="sonheartopia.mp4" type="audio/mp4"></audio>

<div id="intro-screen">
    <div class="lang-picker">
        <span class="flag active" onclick="setLanguage('fr')" id="f-fr">ðŸ‡«ðŸ‡·</span>
        <span class="flag" onclick="setLanguage('en')" id="f-en">ðŸ‡¬ðŸ‡§</span>
    </div>
    <h1 class="heartopia-title">MAPTOPIA</h1>
    <div class="welcome-box">
        <p class="lang-txt" data-key="welcome">Explorez la carte interactive officielle de la communautÃ© franÃ§aise.</p>
        <div class="details-list">
            â€¢ <b class="lang-txt" data-key="nav_title">Navigation :</b> <span class="lang-txt" data-key="tip1">Utilisez le menu Ã  gauche pour filtrer les Ã©lÃ©ments.</span><br>
            â€¢ <b class="lang-txt" data-key="mark_title">Marqueurs :</b> <span class="lang-txt" data-key="tip2">Faites un Clic Droit pour prÃ©parer un repÃ¨re, puis Valider.</span><br>
            â€¢ <b class="lang-txt" data-key="info_title">Infos :</b> <span class="lang-txt" data-key="tip3">Cliquez sur un poisson ou insecte pour voir ses dÃ©tails.</span><br>
            â€¢ <b class="lang-txt" data-key="save_title">Sauvegarde :</b> <span class="lang-txt" data-key="tip4">Vos marqueurs personnels sont enregistrÃ©s sur votre navigateur.</span>
        </div>
        <button id="enter-button" onclick="startExperience()" class="lang-txt" data-key="btn_enter">ENTRER DANS LA CARTE</button>
    </div>
</div>

<a href="https://discord.gg/dc8eZwf2jq" target="_blank" id="discord-link"><img src="Discord-Logo-PNG-Pic.png" id="discord-img"></a>

<div class="ping-legend">
    <div style="text-align:center; font-weight:bold; border-bottom:1px solid #d4af37; padding-bottom:5px;" class="lang-txt" data-key="my_markers">ðŸ“Œ MES MARQUEURS</div>
    <div id="legend-list"></div>
    <div class="visit-counter">
        <p class="lang-txt" data-key="counter_title">AUDIENCE TOTALE</p>
        <div id="compteur-container">
            <a href="https://www.freecounterstat.com" title="page counter">
                <img src="https://counter11.optistats.ovh/private/freecounterstat.php?c=8e8vjwy4nxu9z2z9v7f9d8m6u1n8z9z9" border="0" title="page counter" alt="page counter">
            </a>
        </div>
    </div>
</div>

<div id="map"></div>

<div id="overlay-info" onclick="this.style.display='none'">
    <div class="info-card" onclick="event.stopPropagation()">
        <h2 id="info-name" style="color:#333; margin-top:0;"></h2>
        <img id="info-main" class="info-img-main">
        <img id="info-cond">
        <button onclick="document.getElementById('overlay-info').style.display='none'" style="margin-top:15px; padding:10px 20px; cursor:pointer; background:#8b0000; color:white; border:none; border-radius:5px; font-weight:bold;" class="lang-txt" data-key="close">FERMER</button>
    </div>
</div>

<div class="footer-wiki"><a href="https://jayibwi.wixsite.com/my-site-1" target="_blank" class="lang-txt" data-key="wiki">ðŸ“– WIKI FR COMPLET ðŸ“–</a></div>

<script>
    const translations = {
        fr: {
            welcome: "Explorez la carte interactive officielle de la communautÃ© franÃ§aise.",
            nav_title: "Navigation :", tip1: "Utilisez le menu Ã  gauche pour filtrer les Ã©lÃ©ments.",
            mark_title: "Marqueurs :", tip2: "Faites un Clic Droit pour prÃ©parer un repÃ¨re, puis Valider.",
            info_title: "Infos :", tip3: "Cliquez sur un poisson ou insecte pour voir ses dÃ©tails.",
            save_title: "Sauvegarde :", tip4: "Vos marqueurs personnels sont enregistrÃ©s sur votre navigateur.",
            btn_enter: "ENTRER DANS LA CARTE", my_markers: "ðŸ“Œ MES MARQUEURS", close: "FERMER", wiki: "ðŸ“– WIKI FR COMPLET ðŸ“–",
            counter_title: "AUDIENCE TOTALE", cat_pnj: "PNJ", cat_bus: "BUS", cat_shop: "MAGASINS", cat_lieux: "LIEUX", cat_fish: "POISSONS", cat_bug: "INSECTES",
            pop_new: "Nouveau Marqueur", pop_val: "VALIDER", pop_can: "ANNULER", pop_del: "Supprimer"
        },
        en: {
            welcome: "Explore the official community interactive map.",
            nav_title: "Navigation:", tip1: "Use the left menu to filter elements.",
            mark_title: "Markers:", tip2: "Right-click to place a marker, then Confirm.",
            info_title: "Info:", tip3: "Click on fish or insects to see details.",
            save_title: "Save:", tip4: "Your personal markers are saved in your browser.",
            btn_enter: "ENTER THE MAP", my_markers: "ðŸ“Œ MY MARKERS", close: "CLOSE", wiki: "ðŸ“– FULL WIKI ONLINE ðŸ“–",
            counter_title: "TOTAL AUDIENCE", cat_pnj: "NPC", cat_bus: "BUS", cat_shop: "SHOPS", cat_lieux: "PLACES", cat_fish: "FISH", cat_bug: "BUGS",
            pop_new: "New Marker", pop_val: "CONFIRM", pop_can: "CANCEL", pop_del: "Delete"
        }
    };

    let currentLang = 'fr';
    const colors = { rouge: '#e74c3c', bleu: '#3498db', vert: '#2ecc71', jaune: '#f1c40f', violet: '#9b59b6', orange: '#e67e22' };
    const icons = { note: 'ðŸ“Œ', fish: 'ðŸŽ£', bird: 'ðŸ¦œ', bug: 'ðŸ¦‹', wood: 'ðŸŒ²', stone: 'â›°ï¸' };

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('.flag').forEach(f => f.classList.remove('active'));
        document.getElementById('f-' + lang).classList.add('active');
        document.querySelectorAll('.lang-txt').forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang][key]) el.innerText = translations[lang][key];
        });
        refreshMarkers();
        initMenu();
    }

    function startExperience() {
        document.getElementById('main-audio').play().catch(() => {});
        document.getElementById('intro-screen').style.opacity = '0';
        document.getElementById('map').style.opacity = '1';
        setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);
    }

    var bounds = [[-1000, 0], [0, 1000]];
    var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1, zoomControl: false, maxBounds: bounds, maxBoundsViscosity: 1.0 });
    L.imageOverlay('carte.png', bounds).addTo(map);
    map.setView([-500, 500], 1);

    var userPings = JSON.parse(localStorage.getItem('maptopia_pings')) || [];
    var pingMarkers = {};
    var tempPingMarker = null;

    function createFinalMarker(p) {
        var markerHtml = `<div style="background:${colors[p.color]};width:28px;height:28px;border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;">${icons[p.icon]}</div>`;
        var marker = L.marker(p.latlng, {icon: L.divIcon({className:'', html:markerHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);
        marker.bindPopup(`<b>${p.text}</b><br><button onclick="removeUserPing('${p.id}')" style="width:100%; background:#e74c3c; color:white; border:none; padding:5px; margin-top:5px; cursor:pointer; border-radius:3px;">${translations[currentLang].pop_del}</button>`);
        pingMarkers[p.id] = marker;
    }

    map.on('contextmenu', (e) => {
        if(tempPingMarker) map.removeLayer(tempPingMarker);
        var mid = "temp_" + Date.now();
        var tempHtml = `<div style="background:gray;width:28px;height:28px;border:2px dashed white;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0.7;">?</div>`;
        tempPingMarker = L.marker(e.latlng, {icon: L.divIcon({className:'', html:tempHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);
        tempPingMarker.tempColor = 'bleu';
        var div = document.createElement('div');
        div.style.minWidth = "180px";
        div.innerHTML = `<b style="display:block;margin-bottom:5px;text-align:center;">${translations[currentLang].pop_new}</b><input type="text" id="in-${mid}" placeholder="Nom..." style="width:100%; padding:5px; margin-bottom:10px; box-sizing:border-box;"><div style="display:flex; gap:5px; margin-bottom:10px; justify-content:center;">${Object.entries(colors).map(([k,v]) => `<div style="background:${v}; width:20px; height:20px; border-radius:50%; cursor:pointer; border:1px solid transparent;" onclick="selectPingColor('${k}', this)"></div>`).join('')}</div><button onclick="confirmPing('${mid}',${e.latlng.lat},${e.latlng.lng})" style="width:100%; background:#27ae60; color:white; border:none; padding:8px; cursor:pointer; border-radius:4px; font-weight:bold;">${translations[currentLang].pop_val}</button><button onclick="cancelPing()" style="width:100%; background:#95a5a6; color:white; border:none; padding:5px; cursor:pointer; border-radius:4px; margin-top:5px; font-size:10px;">${translations[currentLang].pop_can}</button>`;
        tempPingMarker.bindPopup(div, {closeOnClick: false}).openPopup();
    });

    window.selectPingColor = (c, el) => { tempPingMarker.tempColor = c; el.parentElement.querySelectorAll('div').forEach(d => d.style.borderColor='transparent'); el.style.borderColor='black'; };
    window.cancelPing = () => { if(tempPingMarker) { map.removeLayer(tempPingMarker); tempPingMarker = null; } };
    window.confirmPing = (mid, lat, lng) => {
        var v = document.getElementById('in-'+mid).value || "Lieu";
        var id = "id_"+Date.now();
        var newPing = {id:id, latlng:{lat,lng}, text:v, color:tempPingMarker.tempColor, icon:'note'};
        userPings.push(newPing);
        localStorage.setItem('maptopia_pings', JSON.stringify(userPings));
        map.removeLayer(tempPingMarker);
        tempPingMarker = null;
        createFinalMarker(newPing);
        updateUserLegend();
    };

    window.removeUserPing = (id) => { if(pingMarkers[id]) map.removeLayer(pingMarkers[id]); userPings = userPings.filter(p => p.id != id); localStorage.setItem('maptopia_pings', JSON.stringify(userPings)); updateUserLegend(); };
    
    function updateUserLegend() {
        const list = document.getElementById('legend-list'); list.innerHTML = "";
        userPings.forEach(p => {
            const div = document.createElement('div'); div.className='legend-item';
            div.innerHTML = `<span onclick="map.flyTo([${p.latlng.lat},${p.latlng.lng}], 2)">${icons[p.icon]} ${p.text}</span><button onclick="removeUserPing('${p.id}')" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">X</button>`;
            list.appendChild(div);
        });
    }

    var dataStorage = { pnj:[], bus:[], shop:[], lieux:[] };
    var currentSingleMarker = null;

    function register(cat, pos, nameFr, nameEn, img, opts = {}) {
        dataStorage[cat].push({ name: {fr: nameFr, en: nameEn}, pos: pos, img: img, opts: opts, marker: null, category:cat });
    }

    function refreshMarkers() {
        Object.keys(dataStorage).forEach(cat => {
            dataStorage[cat].forEach(item => {
                if(item.marker) map.removeLayer(item.marker);
                const name = item.name[currentLang];
                if(item.opts.type) {
                    item.marker = L.marker(item.pos, { icon: L.divIcon({ className: 'invisible-marker', html: '', iconSize: [1, 1] }) }).bindTooltip(name, { permanent: true, direction: 'center', className: item.opts.type });
                } else {
                    item.marker = L.marker(item.pos, { icon: L.icon({ iconUrl: item.img, iconSize: (cat=='bus'?[85,85]:[60,60]), iconAnchor: (cat=='bus'?[42,85]:[30,60]) }) }).bindPopup(`<b>${name}</b>`);
                }
                if(item.opts.startOn) item.marker.addTo(map);
            });
        });
    }

    // DONNÃ‰ES PNJ
    register('pnj', [-471,501], "Bob", "Bob", "pnj/bob.png");
    register('pnj', [-526,499], "Atara", "Atara", "pnj/atara.png");
    register('pnj', [-478,493], "Collectionneur", "Collector", "pnj/collectioneur.png");
    register('pnj', [-469,488], "DorothÃ©e", "Dorothee", "pnj/dorothÃ©e.png");
    register('pnj', [-446,493], "Massimo", "Massimo", "pnj/massimo.png");
    register('pnj', [-412,418], "Ka Ching", "Ka Ching", "pnj/ka ching.png");
    register('pnj', [-399,591], "Andrew", "Andrew", "pnj/andrew.png");
    register('pnj', [-259,522], "Eric", "Eric", "pnj/eric.png");
    register('pnj', [-456,549], "Vanya", "Vanya", "pnj/vanya.png");
    register('pnj', [-502,582], "Naniwa", "Naniwa", "pnj/niniwa.png");
    register('pnj', [-502,519], "Joan", "Joan", "pnj/joa.png");
    register('pnj', [-807,419], "Will", "Will", "pnj/will.png");
    register('pnj', [-355,809], "Patti", "Patti", "pnj/patti.png");
    register('pnj', [-653,225], "Vernie", "Vernie", "pnj/vernie.png");
    register('pnj', [-498,526], "Bayley", "Bayley", "pnj/bayley.png");

    // BUS
    register('bus', [-533,340], "Banlieue Ouest", "West Suburb", "bus.png");
    register('bus', [-519,639], "Banlieue Village", "Village Suburb", "bus.png");
    register('bus', [-654,479], "Village PÃªcheurs", "Fishermen Village", "bus.png");
    register('bus', [-532,218], "Champ Fleurs", "Flower Field", "bus.png");
    register('bus', [-222,512], "Montagne Thermale", "Thermal Mountain", "bus.png");
    register('bus', [-373,480], "Banlieue Nord", "North Suburb", "bus.png");
    register('bus', [-497,481], "Place Centrale", "Central Square", "bus.png");
    register('bus', [-500,798], "ForÃªt", "Forest", "bus.png");

    // MAGASINS
    register('shop', [-472,487], "VÃªtements", "Clothes", "vetement.png");
    register('shop', [-474,503], "Meubles", "Furniture", "Meuble.png");
    register('shop', [-496,523], "Animaux", "Pets", "chien.png");
    register('shop', [-440,467], "Librairie", "Bookstore", "Librairie.png");

    // LIEUX
    const lieuxData = [
        {pos:[-538,492], fr:"Place Centrale", en:"Central Square", type:"label-ville"},
        {pos:[-692,506], fr:"Village de PÃªcheurs", en:"Fishermen Village", type:"label-ville"},
        {pos:[-438,513], fr:"Village", en:"Village", type:"label-ville"},
        {pos:[-649,185], fr:"Champ de Fleurs", en:"Flower Field", type:"label-ville"},
        {pos:[-440,184], fr:"Montagne de Baleine", en:"Whale Mountain", type:"label-ville"},
        {pos:[-184,291], fr:"Les Ruines", en:"The Ruins", type:"label-ville"},
        {pos:[-223,501], fr:"Montagne Thermale", en:"Thermal Mountain", type:"label-ville"},
        {pos:[-228,627], fr:"Falaise Rocheuse", en:"Rocky Cliff", type:"label-ville"},
        {pos:[-531,805], fr:"ForÃªt de ChÃªnes Spirituels", en:"Spiritual Oak Forest", type:"label-ville"},
        {pos:[-494,429], fr:"Rue des Arts", en:"Arts Street", type:"label-ville"},
        {pos:[-510,558], fr:"Rue du Jardin", en:"Garden Street", type:"label-ville"},
        {pos:[-736,602], fr:"Quai Oriental", en:"Eastern Pier", type:"label-ville"},
        {pos:[-690,402], fr:"Quai", en:"Pier", type:"label-ville"},
        {pos:[-780,387], fr:"Phare", en:"Lighthouse", type:"label-ville"},
        {pos:[-691,783], fr:"Tremplin", en:"Diving Board", type:"label-ville"},
        {pos:[-338,933], fr:"ÃŽle de la ForÃªt", en:"Forest Island", type:"label-ville"},
        {pos:[-587,406], fr:"Banlieue", en:"Suburb", type:"label-ville"},
        {pos:[-725,208], fr:"Plage Violette", en:"Purple Beach", type:"label-ville"},
        {pos:[-783,478], fr:"Mer Calme", en:"Calm Sea", type:"label-eau"},
        {pos:[-534,92], fr:"Mer de Baleine", en:"Whale Sea", type:"label-eau"},
        {pos:[-68,497], fr:"Ancienne Mer", en:"Ancient Sea", type:"label-eau"},
        {pos:[-536,232], fr:"Lac dans la Prairie", en:"Meadow Lake", type:"label-eau"},
        {pos:[-337,319], fr:"RiviÃ¨re Aurore", en:"Aurora River", type:"label-eau"},
        {pos:[-176,394], fr:"Lac Volcanique", en:"Volcanic Lake", type:"label-eau"},
        {pos:[-265,537], fr:"Lac Thermale", en:"Thermal Lake", type:"label-eau"},
        {pos:[-344,652], fr:"RiviÃ¨re Peu Profonde", en:"Shallow River", type:"label-eau"},
        {pos:[-598,748], fr:"Lac de la ForÃªt", en:"Forest Lake", type:"label-eau"},
        {pos:[-431,774], fr:"Lac de la ForÃªt (Haut)", en:"Forest Lake (Upper)", type:"label-eau"},
        {pos:[-608,481], fr:"Lac de Banlieue", en:"Suburb Lake", type:"label-eau"},
        {pos:[-669,368], fr:"RiviÃ¨re Calme", en:"Calm River", type:"label-eau"},
        {pos:[-674,627], fr:"Fleuve d'Arbres GÃ©ants", en:"Giant Tree River", type:"label-eau"}
    ];
    lieuxData.forEach(l => register('lieux', l.pos, l.fr, l.en, '', {type:l.type, startOn:true}));

    // POISSONS
    const fishList = [
        {name:{fr:"Ablette", en:"Bleak"}, bg:"condition/AA1.png", cond:"condition/Lacs.png"},
        {name:{fr:"Carpe argentÃ©e", en:"Silver Carp"}, bg:"condition/AA1.png", cond:"condition/Lacs.png"},
        {name:{fr:"Grenouille europÃ©enne", en:"European Frog"}, bg:"condition/AA1.png", cond:"condition/Lacs.png"},
        {name:{fr:"Langouste europÃ©enne", en:"European Lobster"}, bg:"condition/LL1.png", cond:"condition/Lacs.png"},
        {name:{fr:"Acantharchus pomotis", en:"Mud Sunfish"}, bg:"condition/AA2.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Barbillon", en:"Barbel"}, bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Ecrevisse noble", en:"Noble Crayfish"}, bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Ecrevisse noble bleue", en:"Blue Noble Crayfish"}, bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Grand black-basse", en:"Largemouth Bass"}, bg:"condition/GG1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Grande huÃ®tre perliÃ¨re", en:"Large Pearl Oyster"}, bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Tanche dorÃ©e", en:"Golden Tench"}, bg:"condition/AA1.png", cond:"condition/Lac_de_la_foret.png"},
        {name:{fr:"Eperlan", en:"Smelt"}, bg:"condition/AA1.png", cond:"condition/Lac_dans_la_prairie.png"},
        {name:{fr:"Poisson rouge", en:"Goldfish"}, bg:"condition/AA1.png", cond:"condition/Lac_dans_la_prairie.png"},
        {name:{fr:"Plie europÃ©enne", en:"European Plaice"}, bg:"condition/LL1.png", cond:"condition/Ancienne_mer.png"},
        {name:{fr:"Poisson-clown", en:"Clownfish"}, bg:"condition/AA1.png", cond:"condition/Ancienne_mer.png"},
        {name:{fr:"Poisson Ã©pineux", en:"Thornback Ray"}, bg:"condition/AA1.png", cond:"condition/Ancienne_mer.png"},
        {name:{fr:"Poisson-globe de riviÃ¨re", en:"River Puffer"}, bg:"condition/LL4.png", cond:"condition/Ancienne_mer.png"},
        {name:{fr:"Aphyosemion striatum", en:"Five-banded Killifish"}, bg:"condition/AA4.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Barbeau", en:"Common Barbel"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Carpe noire", en:"Black Carp"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Loche des rochers", en:"Stone Loach"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Moule", en:"Mussel"}, bg:"condition/CC3.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Omble chevalier", en:"Arctic Char"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Ombrine", en:"Shi Drum"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Poisson Ã  yeux rouges", en:"Red-eye Fish"}, bg:"condition/AA1.png", cond:"condition/Lacs_de_banlieue.png"},
        {name:{fr:"Loche des fleurs", en:"Flower Loach"}, bg:"condition/AA1.png", cond:"condition/Fleuve_darbres_geants.png"},
        {name:{fr:"POISSON-TIGRE Ã  ventre rouge", en:"Red-bellied Tigerfish"}, bg:"condition/AA1.png", cond:"condition/Fleuve_darbres_geants.png"},
        {name:{fr:"Sandre blanc", en:"Zander"}, bg:"condition/GG1.png", cond:"condition/Fleuve_darbres_geants.png"},
        {name:{fr:"Perche de prunier", en:"Plum Perch"}, bg:"condition/LL4.png", cond:"condition/Lacs_montagne_thermale.png"},
        {name:{fr:"Hippocampe", en:"Seahorse"}, bg:"condition/HH1.png", cond:"condition/Mer_baleine.png"},
        {name:{fr:"Maquereau atlantique", en:"Atlantic Mackerel"}, bg:"condition/AA1.png", cond:"condition/Mer_baleine.png"},
        {name:{fr:"Saumon atlantique", en:"Atlantic Salmon"}, bg:"condition/MM1.png", cond:"condition/Mer_baleine.png"},
        {name:{fr:"Saurel", en:"Horse Mackerel"}, bg:"condition/AA1.png", cond:"condition/Mer_baleine.png"},
        {name:{fr:"Pagellus bogaraveo", en:"Blackspot Seabream"}, bg:"condition/AA1.png", cond:"condition/Mer_calme.png"},
        {name:{fr:"Pieuvre naine atlantique", en:"Atlantic Dwarf Octopus"}, bg:"condition/AA1.png", cond:"condition/Mer_calme.png"},
        {name:{fr:"Poisson ruban", en:"Ribbon Fish"}, bg:"condition/AA1.png", cond:"condition/Mer_calme.png"},
        {name:{fr:"Bernard l'Hermite", en:"Hermit Crab"}, bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"},
        {name:{fr:"Crevette de la mer", en:"Sea Shrimp"}, bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"},
        {name:{fr:"Eglefin", en:"Haddock"}, bg:"condition/AA1.png", cond:"condition/Mer_de_lEst.png"},
        {name:{fr:"Gobie", en:"Goby"}, bg:"condition/GG4.png", cond:"condition/Mer_de_lEst.png"},
        {name:{fr:"Grondin perlon", bg:"condition/AA1.png", en:"Tub Gurnard"}, cond:"condition/Mer_de_lEst.png"},
        {name:{fr:"Bonite", en:"Bonito"}, bg:"condition/AA1.png", cond:"condition/Ocean.png"},
        {name:{fr:"ChimÃ¨re argentÃ©e", en:"Rabbit Fish"}, bg:"condition/AA1.png", cond:"condition/Ocean.png"},
        {name:{fr:"Perche de mer", en:"Sea Perch"}, bg:"condition/AA1.png", cond:"condition/Ocean.png"},
        {name:{fr:"Sardine", en:"Sardine"}, bg:"condition/AA1.png", cond:"condition/Ocean.png"},
        {name:{fr:"Baudroie", en:"Anglerfish"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Carpe Papillon", en:"Butterfly Carp"}, bg:"condition/CC3.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Pieuvre", en:"Octopus"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"RÃ©galec", en:"Oarfish"}, bg:"condition/GG4.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Rouget barbet", en:"Red Mullet"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Roussette", en:"Dogfish"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Seiche europÃ©enne", en:"European Cuttlefish"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Turbot", en:"Turbot"}, bg:"condition/AA1.png", cond:"condition/Peche_en_mer.png"},
        {name:{fr:"Blennie de riviÃ¨re", en:"River Blenny"}, bg:"condition/AA1.png", cond:"condition/Riviere_Aurore.png"},
        {name:{fr:"Carpe europÃ©enne", en:"European Carp"}, bg:"condition/CC2.png", cond:"condition/Riviere_Aurore.png"},
        {name:{fr:"Zingel streber", en:"Streber"}, bg:"condition/AA1.png", cond:"condition/Riviere_Aurore.png"},
        {name:{fr:"ComÃ¨te coussut", en:"Comet Fish"}, bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"},
        {name:{fr:"Lotte", en:"Burbot"}, bg:"condition/LL4.png", cond:"condition/Riviere_calme.png"},
        {name:{fr:"Saumon kÃ©ta", en:"Chum Salmon"}, bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"},
        {name:{fr:"Vairon", en:"Minnow"}, bg:"condition/AA1.png", cond:"condition/Riviere_calme.png"},
        {name:{fr:"Epinoche", en:"Stickleback"}, bg:"condition/AA1.png", cond:"condition/Riviere_peu_profonde.png"},
        {name:{fr:"Crevette verte", en:"Green Shrimp"}, bg:"condition/AA1.png", cond:"condition/Rivieres.png"},
        {name:{fr:"Perche de riviÃ¨re", en:"River Perch"}, bg:"condition/AA1.png", cond:"condition/Rivieres.png"},
        {name:{fr:"Tilapia", en:"Tilapia"}, bg:"condition/AA1.png", cond:"condition/Rivieres.png"},
        {name:{fr:"Chabot", en:"Bullhead"}, bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"},
        {name:{fr:"FÃ©ra", en:"Common Whitefish"}, bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"},
        {name:{fr:"TÃªtard", en:"Tadpole"}, bg:"condition/AA1.png", cond:"condition/Source_et_montagne_thermale.png"}
    ];

    // INSECTES
    const bugList = [
        {name:{fr:"Actias neidhoederi", en:"Actias Moth"}, cond:"insecte/Banlieue.png", bg:"insecte/Actias%20neidhoederi2.png"},
        {name:{fr:"AzurÃ© de porcelaine", en:"Porcelain Blue"}, cond:"insecte/Centre%20ville.png", bg:"insecte/AzurÃ©%20de%20porcelaine2.png"},
        {name:{fr:"Bourdon", en:"Bumblebee"}, cond:"insecte/Champs%20de%20fleurs%20+%20Montagne%20de%20baleine.png", bg:"insecte/Bourdon2.png"},
        {name:{fr:"CÃ©toine Ã©toilÃ©e bleue", en:"Blue Star Chafer"}, cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/CÃ©toine%20Ã©toilÃ©e%20bleue2.png"},
        {name:{fr:"CicindÃ¨le verte", en:"Green Tiger Beetle"}, cond:"insecte/Montagne%20thermale.png", bg:"insecte/CicindÃ¨le%20verte2.png"},
        {name:{fr:"Citron aspasia", en:"Common Brimstone"}, cond:"insecte/Banlieue.png", bg:"insecte/Citron%20aspasia2.png"},
        {name:{fr:"Coccinelle Ã  sept points", en:"Seven-spot Ladybird"}, cond:"insecte/Banlieue.png", bg:"insecte/Coccinelle%20Ã %20sept%20points2.png"},
        {name:{fr:"Coccinelle asiatique", en:"Asian Ladybeetle"}, cond:"insecte/Tour%20du%20faon.png", bg:""},
        {name:{fr:"CriocÃ¨re de l'asperge", en:"Asparagus Beetle"}, cond:"insecte/Champs%20de%20fleurs%20+%20Montagne%20de%20baleine.png", bg:"insecte/CriocÃ¨re%20de%20l'asperge2.png"},
        {name:{fr:"Criquet aux pattes massives", en:"Large-legged Grasshopper"}, cond:"insecte/Village%20pÃªcheurs.png", bg:"insecte/Criquet%20aux%20pattes%20massives2.png"},
        {name:{fr:"Grand agrion", en:"Large Damselfly"}, cond:"insecte/Bords%20d'eau%20frÃ©quent%20pour%20l'agroin.png", bg:"insecte/Grand%20agrion2.png"},
        {name:{fr:"Libellule tachetÃ©e", en:"Spotted Dragonfly"}, cond:"insecte/Lacs%20de%20banlieue.png", bg:"insecte/Libellule%20tachetÃ©e2.png"},
        {name:{fr:"Papillon Ã  anneaux rouges", en:"Red-ringed Butterfly"}, cond:"insecte/Event%20insect.png", bg:"insecte/Papillon%20Ã %20anneaux%20rouges2.png"},
        {name:{fr:"Papillon Ã  col rouge", en:"Red-neck Butterfly"}, cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/CÃ©toine%20Ã©toilÃ©e%20bleue2.png"},
        {name:{fr:"Papillon blanc", en:"White Butterfly"}, cond:"insecte/Village%20pÃªcheurs.png", bg:"insecte/Papillon%20blanc2.png"},
        {name:{fr:"Papillon dorÃ©", en:"Golden Butterfly"}, cond:"insecte/ForÃªt.png", bg:"insecte/Papillon%20dorÃ©2.png"},
        {name:{fr:"Parnassien", en:"Parnassian"}, cond:"insecte/Event%20insect.png", bg:"insecte/Parnassien2.png"},
        {name:{fr:"PiÃ©ride du cresson", en:"Cress White"}, cond:"insecte/Centre%20ville.png", bg:"insecte/PiÃ©ride%20du%20cresson2.png"},
        {name:{fr:"Punaise Picasso", en:"Picasso Bug"}, cond:"insecte/Plage%20violette.png", bg:"insecte/Criquet%20aux%20pattes%20massives2.png"},
        {name:{fr:"Pyrochroa", en:"Fire-colored Beetle"}, cond:"insecte/Source%20thermale.png", bg:"insecte/Pyrochroa2.png"},
        {name:{fr:"Pyrrhocoris apterus", en:"Firebug"}, cond:"insecte/Pourtour%20parcelles.png", bg:"insecte/Pyrrhocoris%20apterus2.png"},
        {name:{fr:"Sauterelle de l'oasis", en:"Oasis Grasshopper"}, cond:"insecte/Montagne%20thermale.png", bg:"insecte/Sauterelle%20de%20l'oasis2.png"},
        {name:{fr:"ScarabÃ©e unicorne", en:"Unicorn Beetle"}, cond:"insecte/Quai%20oriental.png", bg:"insecte/AzurÃ©%20de%20porcelaine2.png"}
    ];

    var menuCtrl = L.control({position: 'topleft'});
    menuCtrl.onAdd = function() {
        var div = L.DomUtil.create('div', 'leaflet-control-layers'); div.id = "main-menu";
        return div;
    };
    menuCtrl.addTo(map);

    function initMenu() {
        const menu = document.getElementById('main-menu');
        menu.innerHTML = "";
        const cats = [
            {id:'pnj', key:'cat_pnj', color:'title-pnj'},
            {id:'bus', key:'cat_bus', color:'title-bus'},
            {id:'shop', key:'cat_shop', color:'title-shop'},
            {id:'lieux', key:'cat_lieux', color:'title-lieux'},
            {id:'fish', key:'cat_fish', color:'title-poisson'},
            {id:'bug', key:'cat_bug', color:'title-insecte'}
        ];

        cats.forEach(c => {
            const container = document.createElement('div');
            container.innerHTML = `<div class="accordion-title ${c.color}">${translations[currentLang][c.key]}</div><div class="accordion-content"></div>`;
            const content = container.querySelector('.accordion-content');
            
            if(c.id === 'fish') {
                fishList.forEach(f => {
                    let el = document.createElement('div'); el.className='menu-item'; el.innerText=f.name[currentLang];
                    el.onclick=()=>openOverlay(f.name[currentLang], f.bg, f.cond);
                    content.appendChild(el);
                });
            } else if(c.id === 'bug') {
                bugList.forEach(b => {
                    let el = document.createElement('div'); el.className='menu-item'; el.innerText=b.name[currentLang];
                    el.onclick=()=>openOverlay(b.name[currentLang], b.bg, b.cond);
                    content.appendChild(el);
                });
            } else {
                dataStorage[c.id].forEach(item => {
                    let el = document.createElement('div'); el.className='menu-item'; el.innerText=item.name[currentLang];
                    el.onclick=()=>{ 
                        if(item.category !== 'lieux') {
                            if(item.category != 'bus' && currentSingleMarker) map.removeLayer(currentSingleMarker);
                            if(item.category != 'bus') currentSingleMarker = item.marker;
                            item.marker.addTo(map);
                        }
                        map.flyTo(item.pos, 2); 
                    };
                    content.appendChild(el);
                });
            }
            container.querySelector('.accordion-title').onclick = () => content.classList.toggle('active');
            menu.appendChild(container);
        });
        L.DomEvent.disableScrollPropagation(menu);
        L.DomEvent.disableClickPropagation(menu);
    }

    function openOverlay(name, mainImg, condImg) {
        document.getElementById('info-name').innerText = name; 
        document.getElementById('info-main').src = mainImg; 
        document.getElementById('info-cond').src = condImg; 
        document.getElementById('overlay-info').style.display = 'flex'; 
    }

    refreshMarkers();
    userPings.forEach(p => createFinalMarker(p));
    updateUserLegend(); 
    setTimeout(initMenu, 300);
</script>
</body>
</html>
