<!DOCTYPE html>

<html lang="fr">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Maptopia FR - Rex Position Update</title>

    

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



    <style>

        body { margin: 0; padding: 0; background: url('Heartopia.jpg') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }



        /* INTRO */

        #intro-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 20000; display: flex; align-items: flex-end; justify-content: center; transition: opacity 1s ease; }

        .video-bg-blur { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(20px) brightness(0.4); }

        #intro-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2; border-left: 2px solid #d4af37; border-right: 2px solid #d4af37; }

        .welcome-box { position: relative; bottom: 8%; width: 500px; padding: 30px; background: rgba(0, 0, 0, 0.85); border: 2px solid #d4af37; border-radius: 20px; color: white; z-index: 10; backdrop-filter: blur(10px); text-align: center; }

        #enter-button { padding: 15px 45px; background: linear-gradient(135deg, #8b0000, #d4af37); color: white; border: 1px solid white; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }



        /* MAP & LEFT MENU */

        #map { height: 100vh; width: 100vw; opacity: 0; transition: opacity 2s ease; background: transparent !important; }

        .leaflet-control-layers { left: 20px !important; top: 20px !important; width: 260px !important; background: rgba(255, 255, 255, 0.98) !important; border-radius: 15px !important; padding: 10px !important; max-height: 80vh; overflow-y: auto !important; border: none !important; box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important; }

        

        /* LÃ‰GENDE PINGS PERSO (DROITE) */

        .ping-legend { position: fixed; right: 20px; top: 20px; width: 240px; background: rgba(0,0,0,0.9); border: 2px solid #d4af37; border-radius: 15px; padding: 15px; color: white; z-index: 1000; max-height: 45vh; display: flex; flex-direction: column; pointer-events: auto; }

        .legend-header { display: flex; align-items: center; justify-content: center; position: relative; font-weight: bold; text-transform: uppercase; font-size: 14px; border-bottom: 1px solid #d4af37; padding-bottom: 8px; }

        #legend-list { overflow-y: auto; margin-top: 10px; }

        .legend-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 6px; border-radius: 6px; font-size: 12px; }

        .legend-info { display: flex; align-items: center; cursor: pointer; flex-grow: 1; overflow: hidden; }

        .btn-delete-small { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px; margin-left: 5px; }



        /* AIDE PING */

        .help-icon { background: #d4af37; color: black; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: help; margin-left: 8px; position: absolute; right: 0; }

        .help-tooltip { visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 1001; top: 30px; right: 0; font-size: 11px; line-height: 1.4; border: 1px solid #d4af37; box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-weight: normal; text-transform: none; }

        .help-icon:hover .help-tooltip { visibility: visible; }



        /* Ã‰DITEUR DE PING */

        .ping-editor { display: flex; flex-direction: column; gap: 8px; min-width: 170px; color: #333; }

        .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }

        .choice-btn { border: 1px solid #ccc; border-radius: 5px; padding: 5px; cursor: pointer; text-align: center; font-size: 18px; background: white; }

        .choice-btn.selected { border: 2px solid #8b0000; background: #fff5f5; }

        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 1px solid #999; }

        .color-dot.selected { border: 2px solid #000; transform: scale(1.1); }



        /* ACCORDIONS */

        .accordion-title { color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; text-align: center; font-size: 12px; text-transform: uppercase; }

        .title-pnj { background: #8b0000; } .title-bus { background: #2980b9; } .title-shop { background: #9b59b6; } .title-lieux { background: #27ae60; } .title-poisson { background: #f39c12; }

        .accordion-content { display: none; margin-bottom: 10px; } .accordion-content.active { display: block; }

        .menu-item { display: flex; align-items: center; padding: 8px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #eee; color: #333; }



        /* LABELS */

        .label-ville { background: white !important; border: 2px solid #3498db !important; border-radius: 5px; padding: 2px 8px; font-weight: bold; font-size: 11px; color: #2980b9; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; white-space: nowrap; z-index: 1000 !important; }

        .label-eau { background: rgba(41, 128, 185, 0.8) !important; border: 1px solid #fff !important; border-radius: 5px; padding: 2px 8px; font-size: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; text-align: center; white-space: nowrap; }



        /* FOOTER */

        .footer-wiki { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; z-index: 3000; background: linear-gradient(90deg, #8b0000, #d4af37, #8b0000); display: flex; align-items: center; justify-content: center; border-top: 3px solid white; }

        .footer-wiki a { color: white; text-decoration: none; font-weight: 900; font-size: 20px; text-transform: uppercase; }

        

        #overlay-fish { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: none; align-items: center; justify-content: center; }

        .fish-card { background: white; padding: 25px; border-radius: 20px; border: 3px solid #d4af37; width: 450px; max-width: 90%; text-align: center; }

    </style>

</head>

<body>



<audio id="main-audio"><source src="sonheartopia.mp4" type="audio/mp4"></audio>



<div id="intro-screen">

    <video class="video-bg-blur" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>

    <video id="intro-video" autoplay muted loop playsinline><source src="pere noel.mp4" type="video/mp4"></video>

    <div class="welcome-box">

        <h1>MAPTOPIA FR</h1>

        <button id="enter-button" onclick="startExperience()">ðŸŽ„ ENTRER ðŸŽ„</button>

    </div>

</div>



<div class="ping-legend" id="p-legend">

    <div class="legend-header">

        ðŸ“Œ MES MARQUEURS

        <div class="help-icon">?

            <span class="help-tooltip">

                <b>ðŸ’¡ Personnalisation :</b><br><br>

                â€¢ <b>Clic Droit</b> pour poser un marqueur.<br>

                â€¢ Ils sont <b>sauvegardÃ©s</b> sur ce navigateur.<br>

                â€¢ Cliquez sur un nom pour vous y rendre.

            </span>

        </div>

    </div>

    <div id="legend-list"></div>

</div>



<div id="map"></div>



<div id="overlay-fish" onclick="this.style.display='none'">

    <div class="fish-card" onclick="event.stopPropagation()">

        <h2 id="fish-name" style="color:#333;"></h2>

        <img id="fish-main" style="width:100%; mix-blend-mode: multiply;">

        <img id="fish-cond" style="width:100%;">

        <button onclick="document.getElementById('overlay-fish').style.display='none'" style="margin-top:15px; padding:10px;">FERMER</button>

    </div>

</div>



<div class="footer-wiki"><a href="https://jayibwi.wixsite.com/my-site-1" target="_blank">ðŸ“– WIKI FR COMPLET ðŸ“–</a></div>



<script>

    const colors = { rouge: '#e74c3c', bleu: '#3498db', vert: '#2ecc71', jaune: '#f1c40f', violet: '#9b59b6', orange: '#e67e22' };

    const icons = { note: 'ðŸ“Œ', fish: 'ðŸŽ£', bird: 'ðŸ¦œ', bug: 'ðŸ¦‹', wood: 'ðŸŒ²', stone: 'â›°ï¸' };



    function startExperience() {

        document.getElementById('main-audio').play().catch(() => {});

        document.getElementById('intro-screen').style.opacity = '0';

        document.getElementById('map').style.opacity = '1';

        setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);

    }



    var bounds = [[-1000, 0], [0, 1000]];

    var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1, zoomControl: false });

    L.imageOverlay('carte.png', bounds).addTo(map);

    map.setView([-500, 500], 1);



    // --- PINGS PERSONNELS (LOCALSTORAGE) ---

    var userPings = JSON.parse(localStorage.getItem('maptopia_pings')) || [];

    var pingMarkers = {};

    var tempPing = null;



    function createPing(latlng, text, color, icon, isNew, id) {

        var mid = id || "temp_" + Date.now();

        var markerHtml = `<div style="background:${colors[color]};width:28px;height:28px;border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.4)">${icons[icon]}</div>`;

        var marker = L.marker(latlng, {icon: L.divIcon({className:'', html:markerHtml, iconSize:[28,28], iconAnchor:[14,14]})}).addTo(map);

        

        if (isNew) {

            tempPing = marker;

            var div = document.createElement('div'); div.className = "ping-editor";

            div.innerHTML = `

                <input type="text" id="in-${mid}" placeholder="Nom du lieu..." style="padding:6px;width:100%;box-sizing:border-box;">

                <div class="icon-grid">${Object.entries(icons).map(([k,v]) => `<div class="choice-btn ${k==='note'?'selected':''}" onclick="selectIcon('${k}',this)">${v}</div>`).join('')}</div>

                <div style="display:flex;justify-content:space-between;margin-top:5px;">${Object.entries(colors).map(([k,v]) => `<div class="color-dot ${k==='bleu'?'selected':''}" style="background:${v}" onclick="selectColor('${k}',this)"></div>`).join('')}</div>

                <div style="display:flex;gap:5px;margin-top:8px;">

                    <button onclick="confirmPing('${mid}',${latlng.lat},${latlng.lng})" style="background:#27ae60;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;flex:1;font-weight:bold;">VALIDER</button>

                    <button onclick="cancelPing()" style="background:#888;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;flex:1;font-weight:bold;">ANNULER</button>

                </div>`;

            marker.tempIcon = 'note'; marker.tempColor = 'bleu'; 

            marker.bindPopup(div, {closeOnClick: false, closeButton: false}).openPopup();

        } else {

            pingMarkers[id] = marker;

            marker.bindPopup(`<b>${icons[icon]} ${text}</b><br><button onclick="removeUserPing('${id}')" style="background:#e74c3c;color:white;border:none;width:100%;margin-top:8px;padding:5px;cursor:pointer;">Supprimer</button>`);

        }

    }



    window.selectIcon = (i, el) => { tempPing.tempIcon = i; el.parentElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); };

    window.selectColor = (c, el) => { tempPing.tempColor = c; el.parentElement.querySelectorAll('.color-dot').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); };

    window.cancelPing = () => { if(tempPing) { map.removeLayer(tempPing); tempPing = null; } };

    window.confirmPing = (t, lat, lng) => { 

        var v = document.getElementById('in-'+t).value || "Marqueur"; 

        var icon = tempPing.tempIcon, color = tempPing.tempColor, fid = "id_"+Date.now(); 

        userPings.push({id:fid, latlng:{lat,lng}, text:v, color, icon}); 

        localStorage.setItem('maptopia_pings', JSON.stringify(userPings)); 

        map.removeLayer(tempPing); tempPing = null; 

        createPing({lat,lng}, v, color, icon, false, fid); 

        updateUserLegend(); 

    };

    window.removeUserPing = (id) => { 

        if(pingMarkers[id]) map.removeLayer(pingMarkers[id]); 

        userPings = userPings.filter(p => String(p.id) !== String(id)); 

        localStorage.setItem('maptopia_pings', JSON.stringify(userPings)); 

        updateUserLegend(); 

    };



    function updateUserLegend() {

        const list = document.getElementById('legend-list');

        list.innerHTML = "";

        userPings.forEach(p => {

            const div = document.createElement('div');

            div.className = 'legend-item';

            div.innerHTML = `<div class="legend-info" onclick="map.flyTo([${p.latlng.lat}, ${p.latlng.lng}], 2)"><span style="color:${colors[p.color]};margin-right:8px;">${icons[p.icon]}</span> ${p.text}</div><button class="btn-delete-small" onclick="removeUserPing('${p.id}')">X</button>`;

            list.appendChild(div);

        });

    }



    map.on('contextmenu', (e) => { cancelPing(); createPing(e.latlng, "", "bleu", "note", true); });



    // --- SYSTÃˆME CATEGORIES (PNJ, BUS, SHOP) ---

    var dataStorage = { pnj:[], bus:[], shop:[], lieux:[] };

    var currentSingleMarker = null;



    function register(cat, pos, name, img, opts = {}) {

        let marker;

        if(opts.type) {

            marker = L.marker(pos, {opacity:0}).bindTooltip(name, {permanent:true, direction:'center', className:opts.type}).addTo(map);

        } else {

            let size = (cat === 'bus') ? [85, 85] : [60, 60];

            marker = L.marker(pos, { icon: L.icon({ iconUrl: img, iconSize: size, iconAnchor: [size[0]/2, size[1]], popupAnchor: [0, -size[1]] }) }).bindPopup(`<b>${name}</b>`);

        }

        dataStorage[cat].push({name, pos, marker, category: cat});

    }



    function addCategoryMarker(item) {

        if (item.category === 'bus') {

            if (map.hasLayer(item.marker)) { map.removeLayer(item.marker); } else { item.marker.addTo(map); }

        } else if (item.category === 'pnj' || item.category === 'shop') {

            if (currentSingleMarker) { map.removeLayer(currentSingleMarker); }

            item.marker.addTo(map); currentSingleMarker = item.marker;

        }

        map.flyTo(item.pos, 2);

    }



    // DONNÃ‰ES

    [{pos:[-471,501], name:"Bob", icon:'pnj/bob.png'}, {pos:[-526,499], name:"Atara", icon:'pnj/atara.png'}, {pos:[-478,493], name:"Le Collectionneur", icon:'pnj/collectioneur.png'}, {pos:[-469,488], name:"DorothÃ©e", icon:'pnj/dorothÃ©e.png'}, {pos:[-446,493], name:"Massimo", icon:'pnj/massimo.png'}, {pos:[-412,418], name:"Ka Ching", icon:'pnj/ka ching.png'}, {pos:[-399,591], name:"Andrew", icon:'pnj/andrew.png'}, {pos:[-259,522], name:"Eric", icon:'pnj/eric.png'}, {pos:[-456,549], name:"Vanya", icon:'pnj/vanya.png'}, {pos:[-502,582], name:"Naniwa", icon:'pnj/niniwa.png'}, {pos:[-502,519], name:"Joan", icon:'pnj/joa.png'}, {pos:[-807,419], name:"Will", icon:'pnj/will.png'}, {pos:[-355,809], name:"Patti", icon:'pnj/patti.png'}, {pos:[-653,225], name:"Vernie", icon:'pnj/vernie.png'}, {pos:[-498,526], name:"Bayley", icon:'pnj/bayley.png'}].forEach(p => register('pnj', p.pos, p.name, p.icon));

    [["Banlieue Ouest",[-533,340]], ["Banlieue Village",[-519,639]], ["Village PÃªcheurs",[-654,479]], ["Champ Fleurs",[-532,218]], ["Montagne Thermale",[-222,512]], ["Banlieue Nord",[-373,480]], ["Place Centrale",[-497,481]], ["ForÃªt",[-500,798]]].forEach(b => register('bus', b[1], b[0], 'bus.png'));

    [

        { pos: [-538, 492], name: "Place Centrale", type: "label-ville" }, { pos: [-692, 506], name: "Village de PÃªcheurs", type: "label-ville" }, 

        { pos: [-445, 455], name: "Rue des Habitants", type: "label-ville" }, 

        { pos: [-494, 429], name: "Rue des Arts", type: "label-ville" },

        { pos: [-512, 553], name: "Rue du Jardin", type: "label-ville" },

        { pos: [-428, 182], name: "Montagne de Baleine", type: "label-ville" }, 

        { pos: [-185, 290], name: "Les Ruines", type: "label-ville" }, { pos: [-224, 639], name: "Falaise Rocheuse", type: "label-ville" }, 

        { pos: [-367, 808], name: "Tour Faon", type: "label-ville" }, { pos: [-649, 185], name: "Champ de Fleurs", type: "label-ville" }, 

        { pos: [-736, 602], name: "Quai Oriental", type: "label-ville" }, { pos: [-780, 387], name: "Phare", type: "label-ville" }, 

        { pos: [-531, 805], name: "ForÃªt de ChÃªnes Spirituels", type: "label-ville" }, { pos: [-227, 508], name: "Source thermale", type: "label-ville" },

        { pos: [-332, 320], name: "RiviÃ¨re Aurore", type: "label-eau" }, { pos: [-168, 391], name: "Lac Volcanique", type: "label-eau" },

        { pos: [-200, 390], name: "Lac de la montagne thermale", type: "label-eau" }, { pos: [-262, 534], name: "Lac de la montagne thermale", type: "label-eau" },

        { pos: [-387, 457], name: "Lac de banlieue", type: "label-eau" }, { pos: [-445, 621], name: "Lac de banlieue", type: "label-eau" },

        { pos: [-604, 489], name: "Lac de banlieue", type: "label-eau" }, { pos: [-439, 778], name: "Lac de la forÃªt", type: "label-eau" },

        { pos: [-598, 744], name: "Lac de la forÃªt", type: "label-eau" }, { pos: [-667, 615], name: "Fleuve d'arbres gÃ©ants", type: "label-eau" },

        { pos: [-783, 478], name: "Mer Calme", type: "label-eau" }, { pos: [-534, 92], name: "Mer de Baleine", type: "label-eau" }, 

        { pos: [-68, 497], name: "Ancienne Mer", type: "label-eau" },

        { pos: [-472, 487], name: "Magasin de VÃªtement", icon: 'vetement.png', isShop: true }, 

        { pos: [-474, 503], name: "Magasin de Meuble", icon: 'Meuble.png', isShop: true }, 

        { pos: [-496, 523], name: "Magasin Animaux", icon: 'chien.png', isShop: true }, 

        { pos: [-440, 467], name: "Librairie", icon: 'Librairie.png', isShop: true }

    ].forEach(l => register(l.isShop ? 'shop' : 'lieux', l.pos, l.name, l.icon || '', {type: l.type}));



    const fishList = [{ name: "Ablette", bg: "poisson/ablette1.png", cond: "poisson/Lacs.png" }, { name: "Acantharchus pomotis", bg: "poisson/Acantharchus_pomotis1.png", cond: "poisson/arcantharcus%20pomotis.png" }, { name: "Aphyosemion striatum", bg: "poisson/Aphyosemion%20striatum.png", cond: "poisson/Aphyosemion%20striatum1.png" }, { name: "Barbeau", bg: "poisson/barbeau1.png", cond: "poisson/barbeau.png" }, { name: "Barbillon", bg: "poisson/barbillon1.png", cond: "poisson/barbillon.png" }, { name: "Baudroie", bg: "poisson/baudroie1.png", cond: "poisson/Baudroie.png" }, { name: "Bonite", bg: "poisson/bonite1.png", cond: "poisson/bonite.png" }, { name: "Carpe argentÃ©e", bg: "poisson/carpe_argentee1.png", cond: "poisson/carpe_argentee.png" }, { name: "Carpe europÃ©enne", bg: "poisson/Carpe_europeenne1.png", cond: "poisson/Carpe_europeenne.png" }, { name: "Carpe Papillon", bg: "poisson/carpe%20papillon1.png", cond: "poisson/carpe%20papillon.png" }, { name: "Carpe noire", bg: "poisson/carpe%20noir.png", cond: "poisson/carpe%20noir1.png" }, { name: "ChimÃ¨re argentÃ©e", bg: "poisson/chimere%20argent1.pnj.avif", cond: "poisson/chimere%20argent%C3%A9.png" }, { name: "ComÃ¨te coussut", bg: "poisson/comete_coussut1.png", cond: "poisson/comete_coussut.png" }, { name: "Crabe de ruisseau", bg: "poisson/Crabe_de_ruisseau1.png", cond: "poisson/crabe%20de%20ruisseau.png" }, { name: "Crevette verte", bg: "poisson/crevette_verte1.png", cond: "poisson/crevette%20verte.png" }];



    var menuCtrl = L.control({position: 'topleft'});

    menuCtrl.onAdd = function() {

        var div = L.DomUtil.create('div', 'leaflet-control-layers'); div.id = "main-menu";

        div.innerHTML = `<div id="c-pnj"><div class="accordion-title title-pnj">PNJ</div><div class="accordion-content"></div></div><div id="c-bus"><div class="accordion-title title-bus">BUS</div><div class="accordion-content"></div></div><div id="c-shop"><div class="accordion-title title-shop">MAGASINS</div><div class="accordion-content"></div></div><div id="c-lieux"><div class="accordion-title title-lieux">LIEUX</div><div class="accordion-content"></div></div><div id="c-fish"><div class="accordion-title title-poisson">POISSONS</div><div class="accordion-content"></div></div>`;

        return div;

    };

    menuCtrl.addTo(map);



    function initMenu() {

        ['pnj','bus','shop','lieux'].forEach(cat => {

            var box = document.getElementById('c-'+cat), content = box.querySelector('.accordion-content');

            dataStorage[cat].forEach(item => {

                var el = document.createElement('div'); el.className = 'menu-item'; el.innerHTML = item.name;

                el.onclick = () => addCategoryMarker(item); content.appendChild(el);

            });

            box.querySelector('.accordion-title').onclick = () => content.classList.toggle('active');

        });

        var fCont = document.querySelector('#c-fish .accordion-content');

        fishList.forEach(f => {

            var el = document.createElement('div'); el.className = 'menu-item'; el.innerText = f.name;

            el.onclick = () => {

                document.getElementById('fish-name').innerText = f.name;

                document.getElementById('fish-main').src = f.bg;

                document.getElementById('fish-cond').src = f.cond;

                document.getElementById('overlay-fish').style.display = 'flex';

            };

            fCont.appendChild(el);

        });

        document.querySelector('#c-fish .accordion-title').onclick = () => fCont.classList.toggle('active');

        

        L.DomEvent.disableScrollPropagation(document.getElementById('main-menu'));

        L.DomEvent.disableClickPropagation(document.getElementById('main-menu'));

        L.DomEvent.disableScrollPropagation(document.getElementById('p-legend'));

        L.DomEvent.disableClickPropagation(document.getElementById('p-legend'));

    }



    userPings.forEach(p => createPing(p.latlng, p.text, p.color, p.icon, false, p.id));

    setTimeout(initMenu, 300);

    updateUserLegend();

</script>

</body>

</html>
