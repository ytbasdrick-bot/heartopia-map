<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive Heartopia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* --- ACCUEIL --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle, #2d5a27 0%, #1a3a16 40%, #8b0000 100%);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out; cursor: pointer;
        }
        .snow-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .snowflake { position: absolute; top: -10px; color: white; font-size: 1.5em; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        #splash-video { max-width: 80%; max-height: 65%; border: 5px solid #d4af37; border-radius: 15px; }
        .click-hint { margin-top: 20px; padding: 12px 25px; background: #d4af37; color: #8b0000; font-weight: bold; border-radius: 50px; animation: pulse 2s infinite; }

        /* --- CARTE & ICONS --- */
        #map { height: calc(100vh - 50px); width: 100vw; background: #5da0c2 !important; }
        .map-icon-style { filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.4)); transition: transform 0.2s; }
        .map-icon-style:hover { transform: scale(1.2) translateY(-5px); z-index: 2000 !important; }

        /* --- Ã‰TIQUETTES --- */
        .label-ville {
            background: white !important; border: 2px solid #3498db !important; border-radius: 5px;
            padding: 4px 10px; font-size: 12px; font-weight: bold;
            white-space: nowrap; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .label-eau {
            background: rgba(255, 255, 255, 0.9) !important; border: 2px solid #2980b9 !important; border-radius: 20px;
            padding: 4px 12px; font-size: 11px; font-weight: bold;
            color: #01579b; box-shadow: 0 0 10px rgba(41, 128, 185, 0.4);
        }

        .leaflet-control-layers {
            position: fixed !important; left: 30px !important; top: 30px !important; width: 250px !important;
            background: rgba(255, 255, 255, 0.95) !important; border-radius: 15px !important; padding: 15px !important;
            max-height: 80vh; overflow-y: auto;
        }

        .footer-wiki {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; z-index: 2000;
            background: linear-gradient(90deg, #8b0000 0%, #d4af37 50%, #8b0000 100%);
            border-top: 3px solid #fff; display: flex; justify-content: center; align-items: center;
        }
        .wiki-link { text-decoration: none; color: white; font-weight: bold; }

        /* Cache la vidÃ©o de fond sonore */
        #hidden-audio { display: none; }
    </style>
</head>
<body>

    <video id="hidden-audio" playsinline>
        <source src="heartopia.mp4" type="video/mp4">
    </video>

    <div id="splash-screen">
        <div class="snow-container" id="snow"></div>
        <video id="splash-video" autoplay muted playsinline>
            <source src="pere%20noel.mp4" type="video/mp4">
        </video>
        <div class="click-hint">âœ¨ CLIQUER POUR ENTRER âœ¨</div>
    </div>

    <div class="footer-wiki">
        <a href="https://jayibwi.wixsite.com/my-site-1" target="_blank" class="wiki-link">ðŸ“– ACCÃ‰DER AU WIKI FR DE HEARTOPIA ðŸ“–</a>
    </div>

    <div id="map"></div>

    <script>
        function createSnowflake() {
            const snow = document.getElementById('snow');
            const flake = document.createElement('div');
            flake.className = 'snowflake'; flake.innerHTML = 'â„';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
            flake.style.opacity = Math.random();
            snow.appendChild(flake);
            setTimeout(() => flake.remove(), 5000);
        }
        setInterval(createSnowflake, 150);

        const splash = document.getElementById('splash-screen');
        const splashVideo = document.getElementById('splash-video');
        const bgMusic = document.getElementById('hidden-audio');

        const entryAction = () => { 
            splash.style.opacity = '0'; 
            setTimeout(() => splash.style.display = 'none', 1000); 
            // On active le son et on lance la lecture au premier clic
            bgMusic.muted = false;
            bgMusic.play().catch(e => console.log("L'auto-play a Ã©tÃ© bloquÃ© par le navigateur"));
        };

        splashVideo.onended = entryAction; 
        splash.onclick = entryAction;

        var map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoom: 1 });
        var bounds = [[-1000, 0], [0, 1000]];
        L.imageOverlay('carte.png', bounds).addTo(map);
        map.setView([-500, 500], 1);

        var groupeLieux = L.layerGroup().addTo(map);
        var groupeBus = L.layerGroup().addTo(map);

        function createIcon(url, size = 70) {
            return L.icon({ 
                iconUrl: url, 
                iconSize: [size, size], 
                iconAnchor: [size / 2, size], popupAnchor: [0, -size], 
                className: 'map-icon-style' 
            });
        }

        var overlays = {};
        
        var pnjData = [
            { pos: [-471, 501], name: "Bob", icon: 'bob.png' },
            { pos: [-526, 499], name: "Atara", icon: 'atara.png' },
            { pos: [-478, 493], name: "Le Collectionneur", icon: 'collectioneur.png' },
            { pos: [-469, 488], name: "DorothÃ©e", icon: 'dorothÃ©e.png' },
            { pos: [-446, 493], name: "Massimo", icon: 'massimo.png' },
            { pos: [-412, 418], name: "Ka Ching", icon: 'ka ching.png' },
            { pos: [-399, 591], name: "Andrew", icon: 'andrew.png' },
            { pos: [-259, 522], name: "Eric", icon: 'eric.png' },
            { pos: [-456, 549], name: "Vanya", icon: 'vanya.png' },
            { pos: [-502, 582], name: "Naniwa", icon: 'niniwa.png' },
            { pos: [-502, 519], name: "Joan", icon: 'joa.png' },
            { pos: [-807, 419], name: "Will", icon: 'will.png' },
            { pos: [-355, 809], name: "Patti", icon: 'patti.png' },
            { pos: [-653, 225], name: "Vernie", icon: 'vernie.png' }
        ];

        pnjData.forEach(p => {
            var g = L.layerGroup();
            L.marker(p.pos, {icon: createIcon(p.icon)}).addTo(g).bindPopup(p.name);
            overlays["ðŸ‘¤ " + p.name] = g;
            g.addTo(map);
        });

        var busData = [
            { pos: [-533, 340], name: "Banlieue Ouest" },
            { pos: [-519, 639], name: "Banlieue du Village" },
            { pos: [-654, 479], name: "Village de PÃªcheurs" },
            { pos: [-532, 218], name: "Champ de Fleurs" },
            { pos: [-222, 512], name: "Montagne Thermale" },
            { pos: [-373, 480], name: "Banlieue Nord du Village" },
            { pos: [-497, 481], name: "Place Centrale" },
            { pos: [-500, 798], name: "ForÃªt" }
        ];
        busData.forEach(b => L.marker(b.pos, {icon: createIcon('bus.png', 90)}).addTo(groupeBus).bindPopup(b.name));

        function addLabel(coords, text, className) {
            L.marker(coords, { opacity: 0 }).addTo(groupeLieux)
             .bindTooltip(text, { permanent: true, direction: 'center', className: className });
        }
        
        addLabel([-538, 492], "Place Centrale", "label-ville");
        addLabel([-692, 506], "Village de PÃªcheurs", "label-ville");
        addLabel([-438, 513], "Village", "label-ville");
        addLabel([-649, 185], "Champ de Fleurs", "label-ville");
        addLabel([-440, 184], "Montagne de Baleine", "label-ville");
        addLabel([-184, 291], "Les Ruines", "label-ville");
        addLabel([-223, 501], "Montagne Thermale", "label-ville");
        addLabel([-228, 627], "Falaise Rocheuse", "label-ville");
        addLabel([-531, 805], "ForÃªt de ChÃªnes Spirituels", "label-ville");
        addLabel([-494, 429], "Rue des Arts", "label-ville");
        addLabel([-510, 558], "Rue du Jardin", "label-ville");
        addLabel([-736, 602], "Quai Oriental", "label-ville");
        addLabel([-690, 402], "Quai", "label-ville");
        addLabel([-780, 387], "Phare", "label-ville");
        addLabel([-691, 783], "Tremplin", "label-ville");
        addLabel([-338, 933], "ÃŽle de la ForÃªt", "label-ville");
        addLabel([-587, 406], "Banlieue", "label-ville");
        addLabel([-725, 208], "Plage Violette", "label-ville");

        addLabel([-783, 478], "Mer Calme", "label-eau");
        addLabel([-534, 92], "Mer de Baleine", "label-eau");
        addLabel([-68, 497], "Ancienne Mer", "label-eau");
        addLabel([-536, 232], "Lac dans la Prairie", "label-eau");
        addLabel([-337, 319], "RiviÃ¨re Aurore", "label-eau");
        addLabel([-176, 394], "Lac Volcanique", "label-eau");
        addLabel([-265, 537], "Lac de Montagne Thermale", "label-eau");
        addLabel([-344, 652], "RiviÃ¨re Peu Profonde", "label-eau");
        addLabel([-598, 748], "Lac de la ForÃªt", "label-eau");
        addLabel([-431, 774], "Lac de la ForÃªt (Haut)", "label-eau");
        addLabel([-608, 481], "Lac de Banlieue", "label-eau");
        addLabel([-669, 368], "RiviÃ¨re Calme", "label-eau");
        addLabel([-674, 627], "Fleuve d'Arbres GÃ©ants", "label-eau");

        overlays["ðŸ“ Lieux & Eaux"] = groupeLieux;
        overlays["ðŸšŒ Bus"] = groupeBus;

        L.control.layers(null, overlays, {collapsed: false}).addTo(map);

        map.on('click', e => { 
            L.popup().setLatLng(e.latlng).setContent("["+Math.round(e.latlng.lat)+", "+Math.round(e.latlng.lng)+"]").openOn(map); 
        });
    </script>
</body>
</html>
